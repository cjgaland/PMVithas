<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klebsiella spp. - Guía Microorganismos</title>
    
    <!-- Dependencias -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Estilos -->
    <link rel="stylesheet" href="../../../css/style.css" />
    <link rel="stylesheet" href="microorganismos-style.css" />
    
    <style>
        /* Estilos del Tooltip Flotante */
        .tooltip-container {
            position: fixed; 
            background-color: white; 
            color: #333; 
            padding: 16px; 
            border-radius: 8px; 
            font-size: 0.85rem; 
            z-index: 9999; 
            max-width: 400px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.25); 
            border: 1px solid #cbd5e1; 
            pointer-events: none; 
            opacity: 0; 
            transition: opacity 0.1s ease-in-out; 
            line-height: 1.5; 
            display: none;
        }
        .tooltip-container.active { opacity: 1; display: block; }
        
        .tooltip-header { 
            font-weight: 700; 
            font-size: 1.05rem; 
            margin-bottom: 10px; 
            padding-bottom: 6px; 
            border-bottom: 2px solid #f1f5f9; 
            color: #1e3a8a; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .tooltip-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 999px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 800; }
        .badge-green { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .badge-amber { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .badge-red { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        .tooltip-row { margin-bottom: 8px; }
        .tooltip-label { font-weight: 700; color: #0284c7; display: block; margin-bottom: 2px; }
        
        .tooltip-alert { 
            background-color: #fef2f2; 
            color: #b91c1c; 
            padding: 8px 10px; 
            border-radius: 6px; 
            border-left: 4px solid #ef4444; 
            margin-top: 10px; 
            font-weight: 500; 
            font-size: 0.85rem; 
            display: flex; 
            gap: 8px; 
            align-items: flex-start; 
        }
        
        /* Estilos de la Leyenda Chips */
        .legend-badge { display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; border: 1px solid transparent; }
        .legend-preferred { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .legend-acceptable { background-color: #fef3c7; color: #92400e; border-color: #fde68a; }
        .legend-avoid { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../../../assets/images/Logos/Vithas-Logo.jpg" alt="Vithas" class="sidebar-logo">
        </div>
        <nav class="nav-links">
            <ul>
                <li><a href="../../../index.html"><i class="fas fa-home"></i> Inicio</a></li>
                <li class="nav-category">Práctica Clínica</li>
                <!-- Enlace de retorno directo a la Guía Principal -->
                <li><a href="../guia-microorganismos.html"><i class="fas fa-arrow-left"></i> Volver a Microorganismos</a></li>
                
                <!-- BLOQUE ACTUAL: Microorganismos (ABIERTO) -->
                <li class="has-submenu open">
                    <a href="#" class="submenu-toggle">
                        <div style="display:flex; align-items:center;">
                            <i class="fas fa-microscope"></i> Microorganismos
                        </div>
                    </a>
                    <ul class="submenu">
                        <li><a href="../guia-microorganismos.html"><i class="fas fa-list"></i> Índice Completo</a></li>
                        <!-- Elemento Activo -->
                        <li><a href="Klebsiella.html" class="submenu-main-link active"><i class="fas fa-grip-lines-vertical"></i> Klebsiella spp.</a></li>
                    </ul>
                </li>

                <!-- Accesos directos a otras Utilidades (Nivel superior) -->
                <li class="nav-category">Otras Herramientas</li>
                
                <li class="has-submenu">
                    <a href="../../Analisis_Clinicos/index.html" class="submenu-toggle">
                        <div style="display:flex; align-items:center;">
                            <i class="fas fa-microscope"></i> Analíticas
                        </div>
                    </a>
                </li>

                <li class="has-submenu">
                    <a href="../../Gold_EPOC/index.html" class="submenu-toggle">
                        <div style="display:flex; align-items:center;">
                            <i class="fas fa-lungs"></i> Guía EPOC
                        </div>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <p>Medicina Interna</p>
            <small>Vithas Xanit Internacional</small>
        </div>
    </aside>

    <div class="main-content">
        <!-- CABECERO GLOBAL -->
        <header class="top-header">
            <div class="header-left">
                <i class="fas fa-bars menu-toggle" id="menuToggle"></i>
                <h2><i class="fas fa-microscope" style="margin-right: 10px;"></i>Guía de Microorganismos</h2>
            </div>
            <div class="header-right">
                <img src="../../../assets/images/Logos/Logo-Vithas-Xanit-Internacional.png" alt="Logo" class="top-logo">
            </div>
        </header>

        <div class="content-wrapper abx-container relative">
            <div id="tooltip" class="tooltip-container"></div>

            <section class="micro-card">
                <!-- CABECERA INTEGRADA (Título + Instrucción) -->
                <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0;">
                    <!-- Parte Izquierda: Icono y Nombre -->
                    <div style="display: flex; align-items: center; gap: 15px; flex-grow: 1;">
                        <div style="background:#e0f7fa; color:#006064; width:55px; height:55px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.75rem; flex-shrink:0;">
                            <i class="fas fa-grip-lines-vertical"></i>
                        </div>
                        <div>
                            <h1 style="color: #003A70; font-size: 1.75rem; margin: 0; font-weight: 700; line-height: 1.1;">Klebsiella spp.</h1>
                        </div>
                    </div>
                    <!-- Parte Derecha: Instrucción -->
                    <div style="color: #888; font-weight: 500; font-size: 0.95rem; display: flex; align-items: center;">
                        <span style="background: #f5f5f5; padding: 5px 12px; border-radius: 20px; border: 1px solid #e0e0e0;">
                            <i class="fas fa-hand-point-up" style="margin-right: 6px; color: #009FE3;"></i> Seleccione foco clínico:
                        </span>
                    </div>
                </div>
                
                <div class="micro-info-box">
                    <h3 class="subsection-title" style="margin-top:0;">Información General</h3>
                    <p><strong>Descripción:</strong> Bacilo Gram-negativo, anaerobio facultativo, no móvil, fermentador de lactosa, con cápsula prominente. Comensal del tracto gastrointestinal.</p>
                    <p><strong>Epidemiología:</strong> Causa infecciones nosocomiales (neumonías asociadas a ventilación, ITU, bacteriemias) y comunitarias (abscesos hepáticos en Asia). Conocido por resistencias (BLEE, KPC).</p>
                    <p><strong>Patogenicidad:</strong> Cápsula polisacárida (factor de virulencia clave, antifagocítica), lipopolisacárido (LPS), fimbrias, producción de carbapenemasas (KPC).</p>
                </div>
                <div class="grid-buttons" id="foci-list"></div>
            </section>

            <section id="resistance-section" class="micro-card hidden">
                <h3 class="subsection-title">2. Seleccione el Perfil de Resistencia</h3>
                <div class="grid-buttons" id="resistance-list"></div>
            </section>

            <section id="treatment-section" class="micro-card hidden">
                <div class="treatment-panel">
                    <div class="treatment-header"><span id="treatment-title">Tratamiento Recomendado</span><i class="fas fa-prescription"></i></div>
                    <div class="treatment-body">
                        <div class="flex flex-wrap justify-center gap-4 mb-6 pb-4 border-b border-gray-100">
                            <span class="legend-badge legend-preferred">Preferido</span>
                            <span class="legend-badge legend-acceptable">Aceptable</span>
                            <span class="legend-badge legend-avoid">A Evitar</span>
                        </div>
                        <div class="treatment-row"><span class="treatment-label">Tratamiento Ideal</span><div id="ideal-antibiotics"></div></div>
                        <div class="treatment-row"><span class="treatment-label">Alternativas</span><div id="alt-antibiotics"></div></div>
                        <div class="treatment-row"><span class="treatment-label">Duración</span><p id="duration-text" class="text-gray-700 font-medium"></p></div>
                        <div class="treatment-row"><span class="treatment-label">Manejo Específico</span><div id="specific-management-content"></div></div>
                        <div class="treatment-row"><span class="treatment-label">Guías de Referencia</span><ul id="guidelines-list" class="list-disc pl-5 text-sm text-gray-600"></ul></div>
                        <div class="treatment-row"><span class="treatment-label">Algoritmo Visual</span><div class="mermaid-container"><div class="mermaid" id="mermaid-graph"></div></div></div>
                    </div>
                </div>
            </section>
        </div>
        <footer class="footer"><p>&copy; 2025 Servicio de Medicina Interna - Hospital Vithas Xanit Internacional.</p></footer>
    </div>

    <script>
        // === BASE DE DATOS DE ANTIBIÓTICOS (TOOLTIPS EXHAUSTIVOS) ===
        const antibioticData = {
            "Ceftriaxona": {
                posologia: "1-2g IV cada 24h", 
                eventosAdversos: "Diarrea, erupción cutánea, dolor en el sitio de infusión, formación de lodo biliar.", 
                biodisponibilidad: "IV: 100%", 
                precauciones: "No usar con soluciones que contengan calcio en neonatos. Alergia a cefalosporinas.", 
                alertas: "Riesgo de reacciones graves con calcio IV en neonatos.", 
                ajusteRenalHepatico: "Renal: No requiere ajuste significativo. Hepático: Precaución en disfunción grave.", 
                interacciones: "Soluciones con calcio (contraindicado en neonatos), anticoagulantes orales (potencia efecto).", 
                status: "preferred"
            },
            "Cefotaxima": {
                posologia: "1-2g IV cada 6-8h", 
                eventosAdversos: "Erupción cutánea, diarrea, dolor en el sitio de infusión.", 
                biodisponibilidad: "IV: 100%", 
                precauciones: "Ajustar en insuficiencia renal. Alergia a cefalosporinas.", 
                alertas: "Riesgo de colitis pseudomembranosa.", 
                ajusteRenalHepatico: "Renal: ClCr < 20 mL/min, reducir dosis. Hepático: No requiere ajuste.", 
                interacciones: "Aminoglucósidos (aumenta nefrotoxicidad).", 
                status: "preferred"
            },
            "Ciprofloxacino": {
                posologia: "400mg IV cada 12h o 500-750mg oral cada 12h", 
                eventosAdversos: "Náuseas, diarrea, tendinitis/ruptura tendinosa, prolongación QT, neuropatía periférica.", 
                biodisponibilidad: "Oral: ~70-80%", 
                precauciones: "Interacciones con cationes divalentes. Riesgo de tendinopatía.", 
                alertas: "Advertencia de caja negra por tendinitis, neuropatía periférica, efectos en SNC.", 
                ajusteRenalHepatico: "Renal: ClCr < 50 mL/min, reducir dosis. Hepático: Precaución en disfunción grave.", 
                interacciones: "Antiácidos, suplementos de hierro/calcio (disminuyen absorción), teofilina (aumenta toxicidad), warfarina (potencia efecto).", 
                status: "acceptable"
            },
            "Levofloxacino": {
                posologia: "500-750mg IV/oral cada 24h", 
                eventosAdversos: "Náuseas, diarrea, tendinitis/ruptura tendinosa, prolongación QT, neuropatía periférica.", 
                biodisponibilidad: "Oral: ~99%", 
                precauciones: "Interacciones con cationes divalentes. Riesgo de tendinopatía.", 
                alertas: "Advertencia de caja negra por tendinitis, neuropatía periférica, efectos en SNC.", 
                ajusteRenalHepatico: "Renal: ClCr < 50 mL/min, reducir dosis. Hepático: No requiere ajuste.", 
                interacciones: "Antiácidos, sucralfato (disminuyen absorción), warfarina (potencia efecto), antiarrítmicos (riesgo de prolongación QT).", 
                status: "acceptable"
            },
            "Meropenem": {
                posologia: "1g IV cada 8h (hasta 2g cada 8h en infecciones graves)", 
                eventosAdversos: "Náuseas, diarrea, erupción cutánea, convulsiones (raro).", 
                biodisponibilidad: "IV: 100%", 
                precauciones: "Ajustar en insuficiencia renal. Historia de convulsiones.", 
                alertas: "Riesgo de convulsiones en pacientes con IR o SNC alterado.", 
                ajusteRenalHepatico: "Renal: ClCr < 50 mL/min, reducir dosis. Hepático: No requiere ajuste.", 
                interacciones: "Ácido valproico (disminuye niveles de valproato, riesgo de convulsiones), probenecid (aumenta niveles de meropenem).", 
                status: "preferred"
            },
            "Imipenem": {
                posologia: "500mg IV cada 6h", 
                eventosAdversos: "Náuseas, vómitos, diarrea, erupción cutánea, convulsiones (mayor riesgo que meropenem).", 
                biodisponibilidad: "IV: 100%", 
                precauciones: "Ajustar en insuficiencia renal. Historia de convulsiones.", 
                alertas: "Mayor riesgo de convulsiones que otros carbapenémicos.", 
                ajusteRenalHepatico: "Renal: ClCr < 70 mL/min, reducir dosis. Hepático: No requiere ajuste.", 
                interacciones: "Ácido valproico (disminuye niveles de valproato, riesgo de convulsiones), ganciclovir (riesgo de convulsiones).", 
                status: "preferred"
            },
            "Cefepime": {
                posologia: "1-2g IV cada 8-12h", 
                eventosAdversos: "Erupción cutánea, diarrea, encefalopatía (en IR).", 
                biodisponibilidad: "IV: 100%", 
                precauciones: "Ajustar en insuficiencia renal. Alergia a cefalosporinas.", 
                alertas: "Riesgo de neurotoxicidad (convulsiones, estado mental alterado) en IR.", 
                ajusteRenalHepatico: "Renal: ClCr < 60 mL/min, reducir dosis. Hepático: No requiere ajuste.", 
                interacciones: "Aminoglucósidos (aumenta nefrotoxicidad), diuréticos de asa (aumenta nefrotoxicidad).", 
                status: "preferred"
            },
            "Piperacilina/Tazobactam": {
                posologia: "4.5g IV cada 6-8h", 
                eventosAdversos: "Erupción cutánea, diarrea, náuseas, mielosupresión (raro).", 
                biodisponibilidad: "IV: 100%", 
                precauciones: "Alergia a penicilinas. Ajustar en insuficiencia renal.", 
                alertas: "Riesgo de nefrotoxicidad en combinación con vancomicina.", 
                ajusteRenalHepatico: "Renal: ClCr < 40 mL/min, reducir dosis. Hepático: No requiere ajuste.", 
                interacciones: "Vancomicina (aumenta riesgo de nefrotoxicidad), metotrexato (aumenta toxicidad), anticoagulantes orales (potencia efecto).", 
                status: "preferred"
            },
            "Ceftazidima/Avibactam": {
                posologia: "2.5g IV cada 8h", 
                eventosAdversos: "Náuseas, vómitos, diarrea, erupción cutánea.", 
                biodisponibilidad: "IV: 100%", 
                precauciones: "Ajustar en insuficiencia renal.", 
                alertas: "Puede causar convulsiones en IR grave.", 
                ajusteRenalHepatico: "Renal: ClCr < 50 mL/min, reducir dosis. Hepático: No requiere ajuste.", 
                interacciones: "Probenecid (aumenta niveles de ceftazidima).", 
                status: "preferred"
            },
            "Meropenem/Vaborbactam": {
                posologia: "4g IV cada 8h", 
                eventosAdversos: "Náuseas, diarrea, cefalea, reacciones en el sitio de infusión.", 
                biodisponibilidad: "IV: 100%", 
                precauciones: "Ajustar en insuficiencia renal. Historia de convulsiones.", 
                alertas: "Riesgo de convulsiones.", 
                ajusteRenalHepatico: "Renal: ClCr < 50 mL/min, reducir dosis. Hepático: No requiere ajuste.", 
                interacciones: "Ácido valproico (disminuye niveles de valproato).", 
                status: "preferred"
            },
            "Colistina": {
                posologia: "2.5-5mg/kg de peso ideal IV cada 12h (dosis de carga inicial 5mg/kg)", 
                eventosAdversos: "Nefrotoxicidad (dosis-dependiente), neurotoxicidad (parestesias, debilidad muscular).", 
                biodisponibilidad: "IV: 100%", 
                precauciones: "Monitorizar función renal. No usar en pacientes con miastenia gravis.", 
                alertas: "Alta nefrotoxicidad y neurotoxicidad.", 
                ajusteRenalHepatico: "Renal: Ajuste estricto según ClCr. Hepático: No requiere ajuste.", 
                interacciones: "Aminoglucósidos, anfotericina B (aumenta nefrotoxicidad), relajantes musculares (potencia efecto).", 
                status: "avoid"
            },
            "Tigeciclina": {
                posologia: "100mg IV dosis de carga, luego 50mg IV cada 12h", 
                eventosAdversos: "Náuseas, vómitos (muy frecuentes), pancreatitis, fotosensibilidad.", 
                biodisponibilidad: "IV: 100%", 
                precauciones: "No usar en bacteriemia por P. aeruginosa. Riesgo de mortalidad en infecciones graves.", 
                alertas: "Aumento de la mortalidad en infecciones graves (neumonía, pie diabético).", 
                ajusteRenalHepatico: "Renal: No requiere ajuste. Hepático: Reducir dosis en disfunción hepática grave.", 
                interacciones: "Warfarina (potencia efecto anticoagulante).", 
                status: "avoid"
            }
        };

        // === DATOS ESPECÍFICOS DE KLEBSIELLA (LITERALES) ===
        const microData = {
            foci: {
                "bacteremia": {
                    name: "Bacteriemia",
                    hasResistances: true,
                    resistances: {
                        "sensible": {
                            profile: "Sensible (no BLEE/KPC)",
                            ideal: ["Ceftriaxona", "Cefotaxima"],
                            alternatives: ["Ciprofloxacino", "Levofloxacino"],
                            duration: "Según foco y evolución clínica",
                            specificManagement: {
                                complementaryTests: [],
                                microbiology: [],
                                otherMeasures: ["Control de foco."]
                            },
                            guidelines: [
                                "Infectious Diseases Society of America (IDSA). Clinical Practice Guidelines for the Management of Antimicrobial-Resistant Gram-Negative Infections. Clin Infect Dis. 2022;74(11):1859-1886."
                            ],
                            // ALGORITMO CORREGIDO - Problema resuelto
                            algorithm: `graph TD; A["Hemocultivos positivos para Klebsiella"] --> B{"¿Sensible (no BLEE/KPC)?"}; B -->|Sí| C["Ceftriaxona o Cefotaxima"]; B -->|No| D["Ver BLEE/KPC"]; D --> E["Control de foco"]; E --> F["Duración según foco y evolución"]; F --> G["Fin"];`
                        },
                        "blee": {
                            profile: "Productor de BLEE",
                            ideal: ["Meropenem", "Imipenem"],
                            alternatives: ["Cefepime (dosis alta)", "Piperacilina/Tazobactam (si sensible in vitro)"],
                            duration: "Según foco y evolución clínica",
                            specificManagement: {
                                complementaryTests: [],
                                microbiology: [],
                                otherMeasures: ["Control de foco."]
                            },
                            guidelines: [
                                "Infectious Diseases Society of America (IDSA). Clinical Practice Guidelines for the Management of Antimicrobial-Resistant Gram-Negative Infections. Clin Infect Dis. 2022;74(11):1859-1886.",
                                "European Society of Clinical Microbiology and Infectious Diseases (ESCMID). Guidance for the management of infections caused by multidrug-resistant Gram-negative bacilli (MDRGNB). Clin Microbiol Infect. 2017;23(12):888-896."
                            ],
                            algorithm: `graph TD; A[Hemocultivos positivos para Klebsiella] --> B{¿Productor de BLEE?}; B -- Sí --> C[Meropenem o Imipenem]; C --> D[Control de foco]; D --> E[Duración según foco y evolución]; E --> F[Fin];`
                        },
                        "kpc": {
                            profile: "Productor de KPC",
                            ideal: ["Ceftazidima/Avibactam", "Meropenem/Vaborbactam"],
                            alternatives: ["Colistina", "Tigeciclina"],
                            duration: "Según foco y evolución clínica",
                            specificManagement: {
                                complementaryTests: [],
                                microbiology: [],
                                otherMeasures: ["Control de foco."]
                            },
                            guidelines: [
                                "Infectious Diseases Society of America (IDSA). Clinical Practice Guidelines for the Management of Antimicrobial-Resistant Gram-Negative Infections. Clin Infect Dis. 2022;74(11):1859-1886.",
                                "European Society of Clinical Microbiology and Infectious Diseases (ESCMID). Guidance for the management of infections caused by multidrug-resistant Gram-negative bacilli (MDRGNB). Clin Microbiol Infect. 2017;23(12):888-896."
                            ],
                            algorithm: `graph TD; A[Hemocultivos positivos para Klebsiella] --> B{¿Productor de KPC?}; B -- Sí --> C[Ceftazidima/Avibactam o Meropenem/Vaborbactam]; C --> D[Control de foco]; D --> E[Duración según foco y evolución]; E --> F[Fin];`
                        }
                    }
                },
                "pneumonia": {
                    name: "Neumonía",
                    hasResistances: true,
                    resistances: {
                        "sensible": {
                            profile: "Sensible (no BLEE/KPC)",
                            ideal: ["Ceftriaxona", "Cefotaxima"],
                            alternatives: ["Ciprofloxacino", "Levofloxacino"],
                            duration: "7-14 días",
                            specificManagement: {
                                complementaryTests: ["Radiografía de tórax.", "Considerar TAC de tórax si complicaciones."],
                                microbiology: ["Cultivo de esputo (si productivo).", "Hemocultivos."],
                                otherMeasures: ["Soporte respiratorio si necesario."]
                            },
                            guidelines: [
                                "Infectious Diseases Society of America (IDSA). Clinical Practice Guidelines for the Management of Community-Acquired Pneumonia. Clin Infect Dis. 2019;68(2):e1-e50."
                            ],
                            algorithm: `graph TD; A[Inicio] --> B["Sospecha de Neumonía por Klebsiella"]; B --> C["Radiografía/TAC de tórax"]; C --> D["Cultivos (esputo, hemocultivos)"]; D --> E{"¿Sensible (no BLEE/KPC)?"}; E -- Sí --> F["Ceftriaxona o Cefotaxima"]; F --> G["Soporte respiratorio si necesario"]; G --> H["Duración: 7-14 días"]; H --> I[Fin];`
                        },
                        "blee": {
                            profile: "Productor de BLEE",
                            ideal: ["Meropenem", "Imipenem"],
                            alternatives: ["Cefepime (dosis alta)", "Piperacilina/Tazobactam (si sensible in vitro)"],
                            duration: "10-14 días",
                            specificManagement: {
                                complementaryTests: ["Radiografía de tórax.", "Considerar TAC de tórax si complicaciones."],
                                microbiology: ["Cultivo de esputo (si productivo).", "Hemocultivos."],
                                otherMeasures: ["Soporte respiratorio si necesario."]
                            },
                            guidelines: [
                                "Infectious Diseases Society of America (IDSA). Clinical Practice Guidelines for the Management of Antimicrobial-Resistant Gram-Negative Infections. Clin Infect Dis. 2022;74(11):1859-1886.",
                                "European Society of Clinical Microbiology and Infectious Diseases (ESCMID). Guidance for the management of infections caused by multidrug-resistant Gram-negative bacilli (MDRGNB). Clin Microbiol Infect. 2017;23(12):888-896."
                            ],
                            algorithm: `graph TD; A[Inicio] --> B["Sospecha de Neumonía por Klebsiella"]; B --> C["Radiografía/TAC de tórax"]; C --> D["Cultivos (esputo, hemocultivos)"]; D --> E{"¿Productor de BLEE?"}; E -- Sí --> F["Meropenem o Imipenem"]; F --> G["Soporte respiratorio si necesario"]; G --> H["Duración: 10-14 días"]; H --> I[Fin];`
                        },
                        "kpc": {
                            profile: "Productor de KPC",
                            ideal: ["Ceftazidima/Avibactam", "Meropenem/Vaborbactam"],
                            alternatives: ["Colistina (inhalada/IV)", "Tigeciclina"],
                            duration: "10-14 días",
                            specificManagement: {
                                complementaryTests: ["Radiografía de tórax.", "Considerar TAC de tórax si complicaciones."],
                                microbiology: ["Cultivo de esputo (si productivo).", "Hemocultivos."],
                                otherMeasures: ["Soporte respiratorio si necesario."]
                            },
                            guidelines: [
                                "Infectious Diseases Society of America (IDSA). Clinical Practice Guidelines for the Management of Antimicrobial-Resistant Gram-Negative Infections. Clin Infect Dis. 2022;74(11):1859-1886.",
                                "European Society of Clinical Microbiology and Infectious Diseases (ESCMID). Guidance for the management of infections caused by multidrug-resistant Gram-negative bacilli (MDRGNB). Clin Microbiol Infect. 2017;23(12):888-896."
                            ],
                            algorithm: `graph TD; A[Inicio] --> B["Sospecha de Neumonía por Klebsiella"]; B --> C["Radiografía/TAC de tórax"]; C --> D["Cultivos (esputo, hemocultivos)"]; D --> E{"¿Productor de KPC?"}; E -- Sí --> F["Ceftazidima/Avibactam o Meropenem/Vaborbactam"]; F --> G["Soporte respiratorio si necesario"]; G --> H["Duración: 10-14 días"]; H --> I[Fin];`
                        }
                    }
                }
            }
        };

        // --- LÓGICA DE INTERFAZ ---
        const fociList = document.getElementById('foci-list');
        const resistanceSection = document.getElementById('resistance-section');
        const resistanceList = document.getElementById('resistance-list');
        const treatmentSection = document.getElementById('treatment-section');
        const tooltip = document.getElementById('tooltip');

        let currentFocus = null;

        function init() {
            mermaid.initialize({ startOnLoad: false, theme: 'default' });
            for (const key in microData.foci) {
                const btn = document.createElement('div');
                btn.className = 'btn-select';
                btn.innerHTML = `<i class="fas fa-bullseye mr-2"></i> ${microData.foci[key].name}`;
                btn.onclick = () => selectFocus(key, btn);
                fociList.appendChild(btn);
            }
            // Listener global para mover tooltip
            document.addEventListener('mousemove', function(e) {
                if (tooltip.classList.contains('active')) {
                    positionTooltip(e);
                }
            });
        }

        function selectFocus(key, btnElement) {
            document.querySelectorAll('#foci-list .btn-select').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            
            currentFocus = microData.foci[key];
            resistanceSection.classList.add('hidden');
            treatmentSection.classList.add('hidden');
            resistanceList.innerHTML = '';

            if (currentFocus.hasResistances) {
                resistanceSection.classList.remove('hidden');
                for (const rKey in currentFocus.resistances) {
                    const rData = currentFocus.resistances[rKey];
                    const rBtn = document.createElement('div');
                    rBtn.className = 'btn-select';
                    rBtn.textContent = rData.profile;
                    rBtn.onclick = () => showTreatment(rData, rBtn);
                    resistanceList.appendChild(rBtn);
                }
            } else {
                showTreatment(currentFocus, btnElement); 
            }
        }

        function showTreatment(data, btnElement) {
            if(btnElement) {
                btnElement.parentElement.querySelectorAll('.btn-select').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }

            treatmentSection.classList.remove('hidden');
            
            renderChips(data.ideal, 'ideal-antibiotics', 'chip-ideal');
            renderChips(data.alternatives, 'alt-antibiotics', 'chip-alt');
            document.getElementById('duration-text').textContent = data.duration;
            
            // Renderizar Manejo Específico (Agrupado y Completo)
            const managementContainer = document.getElementById('specific-management-content');
            managementContainer.innerHTML = '';
            
            const categories = [
                { title: "Pruebas Complementarias", key: "complementaryTests", icon: "fas fa-microscope" },
                { title: "Microbiología", key: "microbiology", icon: "fas fa-vial" },
                { title: "Otras Medidas", key: "otherMeasures", icon: "fas fa-notes-medical" }
            ];

            categories.forEach(cat => {
                if(data.specificManagement && data.specificManagement[cat.key] && data.specificManagement[cat.key].length > 0) {
                    const div = document.createElement('div');
                    div.className = "mb-3 p-3 bg-gray-50 rounded border border-gray-100";
                    div.innerHTML = `<h4 class="font-bold text-gray-700 text-sm mb-1"><i class="${cat.icon} mr-2"></i>${cat.title}</h4>`;
                    const ul = document.createElement('ul');
                    ul.className = "list-disc pl-5 text-sm text-gray-600 mb-0";
                    
                    data.specificManagement[cat.key].forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        ul.appendChild(li);
                    });
                    div.appendChild(ul);
                    managementContainer.appendChild(div);
                }
            });

            // Renderizar Guías
            const ulGuidelines = document.getElementById('guidelines-list');
            ulGuidelines.innerHTML = '';
            if(data.guidelines) {
                data.guidelines.forEach(g => {
                    const li = document.createElement('li');
                    li.textContent = g;
                    ulGuidelines.appendChild(li);
                });
            }

            // Renderizar Mermaid
            const graphDiv = document.getElementById('mermaid-graph');
            graphDiv.innerHTML = data.algorithm;
            graphDiv.removeAttribute('data-processed');
            mermaid.init(undefined, graphDiv);

            setTimeout(() => { treatmentSection.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
        }

        function renderChips(list, containerId, className) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            list.forEach(itemString => {
                const parts = itemString.split('+');
                const wrapperSpan = document.createElement('span');
                wrapperSpan.className = "inline-flex items-center flex-wrap gap-1 mr-2 mb-2";

                parts.forEach((part, index) => {
                    const cleanName = part.split('(')[0].trim();
                    const fullText = part.trim();
                    const chip = document.createElement('span');
                    chip.className = `abx-chip ${className}`;
                    chip.textContent = fullText;
                    
                    if (antibioticData[cleanName]) {
                        chip.classList.add('cursor-help');
                        chip.onmouseenter = (e) => showTooltip(e, cleanName);
                        chip.onmouseleave = hideTooltip;
                    }

                    wrapperSpan.appendChild(chip);
                    if (index < parts.length - 1) {
                        const plus = document.createElement('span');
                        plus.textContent = "+";
                        plus.className = "text-gray-400 font-bold mx-1";
                        wrapperSpan.appendChild(plus);
                    }
                });
                container.appendChild(wrapperSpan);
            });
        }

        function showTooltip(e, drugName) {
            const data = antibioticData[drugName];
            if (!data) return;

            let badgeClass = data.status === 'preferred' ? 'badge-green' : 'badge-amber';
            let statusText = data.status === 'preferred' ? 'Preferente' : 'Alternativa';

            tooltip.innerHTML = `
                <div class="tooltip-header">
                    <span>${drugName}</span>
                    <span class="tooltip-badge ${badgeClass}">${statusText}</span>
                </div>
                <div class="tooltip-row"><span class="tooltip-label">Posología:</span> ${data.posologia}</div>
                <div class="tooltip-row"><span class="tooltip-label">E. Adversos:</span> ${data.eventosAdversos}</div>
                <div class="tooltip-row"><span class="tooltip-label">Precauciones:</span> ${data.precauciones}</div>
                ${data.alertas ? `<div class="tooltip-alert"><i class="fas fa-exclamation-triangle"></i> ${data.alertas}</div>` : ''}
                <div class="tooltip-section" style="margin-top:8px">
                    <div class="tooltip-row"><span class="tooltip-label">Ajuste Renal:</span> ${data.ajusteRenalHepatico}</div>
                </div>
                <div class="tooltip-row"><span class="tooltip-label">Interacciones:</span> ${data.interacciones}</div>
            `;
            
            tooltip.classList.add('active');
            positionTooltip(e);
        }

        function positionTooltip(e) {
            const tooltipWidth = 400; 
            const tooltipHeight = tooltip.offsetHeight || 350; 
            const padding = 20;

            let left = e.clientX + padding;
            let top = e.clientY + padding;

            if (left + tooltipWidth > window.innerWidth) {
                left = e.clientX - tooltipWidth - padding;
            }

            if (top + tooltipHeight > window.innerHeight) {
                top = e.clientY - tooltipHeight - padding;
            }

            if (left < 0) left = padding;
            if (top < 0) top = padding;

            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
        }

        function hideTooltip() { tooltip.classList.remove('active'); }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>