<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Protocolo Piel y Partes Blandas - Vithas Xanit</title>
  
  <link rel="icon" type="image/png" href="../../../assets/Images/Logos/Favicon-Vithas.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <!-- Estilos Globales -->
  <link rel="stylesheet" href="../../../css/style.css" />
  <!-- Estilos Comunes de Focos -->
  <link rel="stylesheet" href="focos-style.css" />

  <style>
    /* Estilos específicos para las tablas de este protocolo */
    .reference-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .reference-table th, .reference-table td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
    }
    .reference-table th {
      background-color: #f5f5f5;
      color: var(--vithas-blue-dark);
      font-weight: 600;
    }
    
    .checkbox-group label {
        display: flex; 
        align-items: flex-start; 
        gap: 10px; 
        margin-bottom: 8px; 
        cursor: pointer;
        padding: 8px;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        transition: background 0.2s;
    }
    .checkbox-group label:hover { background: #f9fafb; }
    .checkbox-group input[type="checkbox"] {
        margin-top: 3px;
    }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .input-qsofa {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      max-width: 150px;
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="../../../assets/images/Logos/Vithas-Logo.jpg" alt="Vithas" class="sidebar-logo">
    </div>
    <nav class="nav-links">
      <ul>
        <li><a href="../../../index.html"><i class="fas fa-home"></i> Inicio</a></li>
        <li class="nav-category">Práctica Clínica</li>
        
        <!-- Volver al menú de Focos -->
        <li><a href="../guia-focos.html"><i class="fas fa-arrow-left"></i> Volver a Guía Focos</a></li>
        
        <!-- BLOQUE ACTUAL: Focos Infecciosos (ABIERTO) -->
        <li class="has-submenu open">
          <a href="#" class="submenu-toggle">
            <div style="display:flex; align-items:center;">
              <i class="fas fa-virus"></i> Focos Infecciosos
            </div>
          </a>
          <ul class="submenu">
            <li><a href="infec-resp-sup.html"><i class="fas fa-head-side-cough"></i> Vías Resp. Superiores</a></li>
            <li><a href="nac.html"><i class="fas fa-lungs"></i> Neumonía (NAC)</a></li>
            <li><a href="neumonia-nosocomial.html"><i class="fas fa-hospital-user"></i> Neumonía Nosocomial</a></li>
            <li><a href="itu.html"><i class="fas fa-toilet"></i> Infecciones Urinarias</a></li>
            <li><a href="ets.html"><i class="fas fa-venus-mars"></i> ETS</a></li>
            <!-- Elemento Activo -->
            <li><a href="piel-partes-blandas.html" class="submenu-main-link active"><i class="fas fa-hand-dots"></i> Piel y Partes Blandas</a></li>
            <li><a href="osteoarticular.html"><i class="fas fa-bone"></i> Osteoarticular</a></li>
            <li><a href="odontogenas.html"><i class="fas fa-tooth"></i> Odontógenas</a></li>
          </ul>
        </li>

        <!-- Accesos directos a otras Utilidades -->
        <li class="nav-category">Otras Herramientas</li>
        
        <li class="has-submenu">
            <a href="../../Analisis_Clinicos/index.html" class="submenu-toggle">
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-microscope"></i> Analíticas
                </div>
            </a>
        </li>

        <li class="has-submenu">
            <a href="../../Gold_EPOC/index.html" class="submenu-toggle">
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-lungs"></i> Guía EPOC
                </div>
            </a>
        </li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <p>Medicina Interna</p>
      <small>Vithas Xanit Internacional</small>
    </div>
  </aside>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="main-content">
    <!-- CABECERO GLOBAL -->
    <header class="top-header">
      <div class="header-left">
        <i class="fas fa-bars menu-toggle" id="menuToggle"></i>
        <h2><i class="fas fa-map-marked-alt" style="margin-right: 10px;"></i>Guía por Localización</h2>
      </div>
      <div class="header-right">
        <img src="../../../assets/images/Logos/Logo-Vithas-Xanit-Internacional.png" alt="Logo" class="top-logo">
      </div>
    </header>

    <div class="content-wrapper foco-container">
      
      <!-- CABECERA INTEGRADA (Título + Instrucción) -->
      <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0;">
          <!-- Parte Izquierda: Icono y Nombre -->
          <div style="display: flex; align-items: center; gap: 15px; flex-grow: 1;">
              <div style="background:#e0f7fa; color:#006064; width:55px; height:55px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.75rem; flex-shrink:0;">
                  <i class="fas fa-hand-dots"></i>
              </div>
              <div>
                  <h1 style="color: #003A70; font-size: 1.75rem; margin: 0; font-weight: 700; line-height: 1.1;">Infección de Piel y Partes Blandas</h1>
              </div>
          </div>
          <!-- Parte Derecha: Instrucción -->
          <div style="color: #888; font-weight: 500; font-size: 0.95rem; display: flex; align-items: center;">
              <span style="background: #f5f5f5; padding: 5px 12px; border-radius: 20px; border: 1px solid #e0e0e0;">
                  <i class="fas fa-hand-point-up" style="margin-right: 6px; color: #009FE3;"></i> Seleccione escenario clínico:
              </span>
          </div>
      </div>

      <!-- SECCIÓN INTERACTIVA PRINCIPAL -->
      <section class="foco-card">
        <div class="foco-section-title">Flujo de Decisión Terapéutica</div>
        
        <!-- Breadcrumb -->
        <div id="breadcrumb" class="breadcrumb-trail"></div>

        <!-- Área de Preguntas -->
        <div id="question-area">
          <!-- Se inyecta dinámicamente -->
        </div>

        <!-- Área de Resultados -->
        <div id="result-area" class="result-box" style="display: none;">
          <div class="result-title"><i class="fas fa-check-circle"></i> Recomendación de Tratamiento</div>
          <div id="treatment-recommendation"></div>
          <div style="margin-top: 20px;">
            <button onclick="resetApp()" class="btn-action btn-secondary"><i class="fas fa-redo"></i> Reiniciar</button>
          </div>
        </div>

        <!-- Botón Volver (dentro del flujo) -->
        <div style="margin-top: 20px; text-align: right;">
           <button id="back-button" onclick="goBack()" class="btn-action btn-secondary" style="display: none;">Atrás</button>
        </div>
      </section>

      <!-- SECCIONES DE REFERENCIA -->
      <section class="foco-card">
        <div class="foco-section-title">Información de Referencia</div>

        <!-- 1. Definición -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Definición y Clasificación</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <p class="mb-2"><strong>Infecciones de piel y partes blandas (IPPB):</strong> afecciones causadas por microorganismos que afectan la piel, tejido subcutáneo, fascia o músculos, variando en severidad desde celulitis superficial hasta infecciones necrosantes profundas.</p>
          </div>
        </div>

        <!-- 2. Estudio Complementario -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Estudio Complementario</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <ul style="list-style-type: disc; padding-left: 20px;">
              <li>Constantes vitales, antecedentes epidemiológicos.</li>
              <li>Si infección localizada sin signos de afectación sistémica o Tª&gt;37.7ºC, no es preciso pruebas adicionales.</li>
              <li>Si afectación del estado general, Tª&gt;37.7ºC o afectación extensa: hemograma, coagulación y bioquímica con reactantes de fase aguda.</li>
              <li>Si Tª&gt;37.7ºC, no olvidar hemocultivos x2.</li>
            </ul>
          </div>
        </div>

        <!-- 3. Microbiología -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Microbiología</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <ul style="list-style-type: disc; padding-left: 20px;">
              <li><strong>Hemocultivos (x2):</strong> Previo al inicio del tratamiento antibiótico. No debe demorar el inicio.</li>
              <li><strong>Muestras locales:</strong> Si presentación purulenta, toma de muestra de pus o exudado.</li>
            </ul>
          </div>
        </div>

        <!-- 4. Gravedad (SOFA) -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Evaluación Gravedad (Criterios Sepsis/SOFA)</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <p><strong>Signos de Alarma:</strong> Dolor "exagerado" para la extensión visible, rápida progresión, crepitación, bullas hemorrágicas, anestesia cutánea.</p>
            <p style="margin-bottom:10px;"><strong>Criterios de gravedad:</strong> qSOFA/SOFA &ge; 2, ingreso en UCI.</p>
            
            <table class="reference-table">
                <thead>
                    <tr>
                        <th>Órgano</th>
                        <th>Parámetro</th>
                        <th>1 pto</th>
                        <th>2 ptos</th>
                        <th>3 ptos</th>
                        <th>4 ptos</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Respiratorio</td><td>PaO2/FiO2</td><td>&lt; 400</td><td>&lt; 300</td><td>&lt; 200 + VM</td><td>&lt; 100 + VM</td></tr>
                    <tr><td>Coagulación</td><td>Plaquetas</td><td>&lt; 150</td><td>&lt; 100</td><td>&lt; 50</td><td>&lt; 20</td></tr>
                    <tr><td>Hígado</td><td>Bilirrubina</td><td>1.2-1.9</td><td>2-5.9</td><td>6-11.9</td><td>&gt; 12</td></tr>
                    <tr><td>Cardio</td><td>PAM</td><td>&lt; 70</td><td>Dopa &lt; 5</td><td>Dopa &gt; 5</td><td>Dopa &gt; 15</td></tr>
                    <tr><td>SNC</td><td>Glasgow</td><td>14-13</td><td>12-10</td><td>9-6</td><td>&lt; 6</td></tr>
                    <tr><td>Renal</td><td>Creatinina</td><td>1.2-1.9</td><td>2-3.4</td><td>3.5-4.9</td><td>&gt; 5</td></tr>
                </tbody>
            </table>
            <p style="margin-top:10px; font-size:0.85rem;"><strong>1-3 ptos:</strong> Disfunción orgánica. <strong>&gt; 3 ptos:</strong> Fallo multiorgánico.</p>
          </div>
        </div>

        <!-- 5. Biodisponibilidad -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Biodisponibilidad Oral de Antibióticos</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <table class="reference-table">
                <thead>
                    <tr>
                        <th>Antibiótico</th>
                        <th>Biodisponibilidad Oral</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Amoxicilina</td><td>80%</td></tr>
                    <tr><td>Amoxicilina-clavulánico</td><td>75% en solución, 60% sólido</td></tr>
                    <tr><td>Cefditoreno</td><td>40-50%</td></tr>
                    <tr><td>Ciprofloxacino</td><td>75%</td></tr>
                    <tr><td>Levofloxacino</td><td>&gt;95%</td></tr>
                    <tr><td>Linezolid</td><td>100%</td></tr>
                </tbody>
            </table>
          </div>
        </div>

        <!-- 6. Resistencias -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Factores de Riesgo (SARM, Pseudomonas, BLEE)</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <p class="mb-2">En infecciones de piel y partes blandas, los microorganismos resistentes más frecuentes son el <em>S aureus</em> resistente a meticilina (SARM) y la <em>Pseudomonas aeruginosa</em>.</p>
            <table class="reference-table">
                <thead>
                    <tr>
                        <th>FdR para SARM</th>
                        <th>FdR para P. aeruginosa</th>
                        <th>FdR para BLEE</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>&gt;1 Coma</td><td>&gt;1 Ingreso reciente</td><td>&gt;1 ATB &lt; 3m</td></tr>
                    <tr><td>TCE</td><td>&gt;4 ciclos ATB/año</td><td>Ingreso &lt; 3m</td></tr>
                    <tr><td>DM</td><td>ATB &lt; 3m</td><td>Procedimiento invasivo</td></tr>
                    <tr><td>SARM previo</td><td>EPOC grave</td><td>Residencia ancianos</td></tr>
                    <tr><td>ATB &lt; 3m</td><td>Corticoides orales*</td><td>Inmunosupresión</td></tr>
                    <tr><td>Gripe reciente</td><td>Aislamiento previo</td><td>Edad avanzada</td></tr>
                    <tr><td>Alcoholismo</td><td></td><td>Aislamiento previo BLEE</td></tr>
                    <tr><td>ERC</td><td></td><td></td></tr>
                    <tr><td>UDVP</td><td></td><td></td></tr>
                    <tr><td>Fibrosis quística</td><td></td><td></td></tr>
                </tbody>
            </table>
            <p style="margin-top: 10px; font-size: 0.85rem; color: #666;">*Corticoides orales: &gt; 10 mg de prednisolona diaria en las últimas 2 semanas.</p>
          </div>
        </div>

      </section>

    </div>
    
    <!-- FOOTER -->
    <footer class="footer">
      <p>&copy; 2025 Servicio de Medicina Interna - Hospital Vithas Xanit Internacional.</p>
    </footer>
  </div>

  <!-- TOOLTIP GLOBAL -->
  <div id="global-tooltip"></div>

  <!-- LÓGICA DEL PORTAL -->
  <script src="../../../js/main.js"></script>

  <script>
    const questionArea = document.getElementById('question-area');
    const resultArea = document.getElementById('result-area');
    const treatmentRecommendation = document.getElementById('treatment-recommendation');
    const backButton = document.getElementById('back-button');
    const breadcrumbDiv = document.getElementById('breadcrumb');
    const globalTooltip = document.getElementById('global-tooltip');

    // DATOS DE ANTIBIÓTICOS (Tooltips)
    const antibioticData = {
        "Amoxicilina": { posologia: "500 mg cada 8 horas.", precauciones: "Alergia a penicilinas. Ajustar en IR." },
        "Amoxi-clav": { posologia: "875/125 mg cada 8h (oral) / 2g cada 8h (iv grave).", precauciones: "Hepatotoxicidad." },
        "Cefadroxilo": { posologia: "1g cada 12 horas.", precauciones: "Alergia cefalosporinas." },
        "Clindamicina": { posologia: "300-600 mg cada 6-8 horas.", precauciones: "Riesgo colitis C. difficile." },
        "Cotrimoxazol": { posologia: "800/160 mg cada 12 horas.", precauciones: "Alergia sulfamidas. Ajustar en IR." },
        "Mupirocina": { posologia: "Tópica 2% cada 8 horas.", precauciones: "Uso local exclusivo." },
        "Ácido fusídico": { posologia: "Tópico 2% cada 12 horas.", precauciones: "Uso local exclusivo." },
        "Ciprofloxacino": { posologia: "500-750 mg cada 12 horas.", precauciones: "Tendinitis, QT largo." },
        "Levofloxacino": { posologia: "500-750 mg cada 24 horas.", precauciones: "Tendinitis, QT largo." },
        "Ceftriaxona": { posologia: "2g IV cada 24 horas.", precauciones: "Alergia cefalosporinas." },
        "Meropenem": { posologia: "1g IV cada 8 horas.", precauciones: "Alergia carbapenémicos." },
        "Piperacilina/Tazobactam": { posologia: "4g/0.5g IV cada 6-8 horas.", precauciones: "Ajustar en IR." },
        "Linezolid": { posologia: "600 mg cada 12 horas.", precauciones: "Monitorizar plaquetas. Riesgo sd. serotoninérgico." },
        "Tigeciclina": { posologia: "100 mg carga, luego 50 mg cada 12h.", precauciones: "Evitar en bacteriemia." },
        "Aztreonam": { posologia: "1-2g IV cada 8 horas.", precauciones: "Opción en alergia severa B-lact." },
        "Metronidazol": { posologia: "500 mg cada 8 horas.", precauciones: "Evitar alcohol (efecto antabús)." }
    };

    // VARIABLES DE ESTADO
    let currentStepId = 'start';
    let history = [];

    // FLUJO DE TRABAJO (Replicado de PPB.html)
    const workflow = {
        'start': {
            name: 'Inicio',
            question: '¿El paciente cumple con criterios de gravedad (qSOFA/SOFA)?',
            options: [
                { text: 'Sí (Grave)', next: 'grave_flow_ppb' },
                { text: 'No (No Grave)', next: 'not_grave_flow_ppb' },
                { text: 'No lo sé / Calcular qSOFA', next: 'calculate_qsofa' }
            ]
        },
        'calculate_qsofa': {
            name: 'Calculadora qSOFA',
            type: 'qsofa_calculator'
        },
        'qsofa_result_display': {
            name: 'Resultado qSOFA',
            type: 'qsofa_result'
        },
        // --- RAMA GRAVE ---
        'grave_flow_ppb': {
            name: 'Infección Grave',
            question: 'Selecciona el tipo de infección grave:<br><a href="https://iqb.es/dermatologia/atlas/toc02.htm" target="_blank" style="font-size:0.9rem; color:var(--vithas-blue-light); text-decoration:underline;">Ver Atlas de Dermatología</a>',
            options: [
                { text: 'Celulitis grave', next: 'celulitis_grave_treatment' },
                { text: 'Celulitis necrotizante', next: 'celulitis_necrotizante_treatment' },
                { text: 'Gangrena de Fournier', next: 'gangrena_fournier_treatment' },
                { text: 'Fascitis necrotizante', next: 'fascitis_necrotizante_type_question' }
            ]
        },
        'fascitis_necrotizante_type_question': {
            name: 'Tipo Fascitis',
            question: '¿Es fascitis necrotizante adquirida en la comunidad o nosocomial?',
            options: [
                { text: 'Adquirida en la comunidad', next: 'fascitis_necrotizante_comunidad_treatment' },
                { text: 'Nosocomial', next: 'fascitis_necrotizante_nosocomial_treatment' }
            ]
        },
        // --- RAMA NO GRAVE ---
        'not_grave_flow_ppb': {
            name: 'Infección No Grave',
            question: 'Selecciona el tipo de infección no grave:<br><a href="https://iqb.es/dermatologia/atlas/toc02.htm" target="_blank" style="font-size:0.9rem; color:var(--vithas-blue-light); text-decoration:underline;">Ver Atlas de Dermatología</a>',
            options: [
                { text: 'Foliculitis', next: 'foliculitis_severity_question' },
                { text: 'Forúnculos', next: 'forunculos_treatment' },
                { text: 'Absceso cutáneo', next: 'absceso_type_question' },
                { text: 'Impétigo contagioso o ampolloso', next: 'impetigo_treatment' },
                { text: 'Ectima', next: 'ectima_treatment' },
                { text: 'Erisipela', next: 'erisipela_treatment' },
                { text: 'Celulitis no grave', next: 'celulitis_no_grave_sarm_check' },
                { text: 'Mordedura animales', next: 'mordedura_animales_treatment' }
            ]
        },
        'foliculitis_severity_question': {
            name: 'Severidad Foliculitis',
            question: '¿Es foliculitis leve o extensa?',
            options: [
                { text: 'Leve', next: 'foliculitis_leve_treatment' },
                { text: 'Extensa', next: 'foliculitis_extensa_sarm_check' }
            ]
        },
        'foliculitis_extensa_sarm_check': {
            name: 'Foliculitis SARM Check',
            question: '¿El paciente presenta factores de riesgo para SARM?',
            type: 'sarm_factors_checker_foliculitis'
        },
        'absceso_type_question': {
            name: 'Tipo Absceso',
            question: '¿Es un absceso cutáneo simple o complicado?',
            options: [
                { text: 'Simple', next: 'absceso_simple_treatment' },
                { text: 'Complicado', next: 'absceso_complicado_sarm_check' }
            ]
        },
        'absceso_complicado_sarm_check': { // Nota: en original, ambos caminos llevan al mismo tto (Septrim)
            name: 'Absceso Complicado SARM',
            question: '¿El paciente presenta factores de riesgo para SARM?',
            type: 'sarm_factors_checker_absceso'
        },
        'celulitis_no_grave_sarm_check': {
            name: 'Celulitis SARM Check',
            question: '¿El paciente presenta factores de riesgo para SARM?',
            type: 'sarm_factors_checker_celulitis'
        },
        
        // Tratamientos Finales
        'celulitis_grave_treatment': { name: 'Tto Celulitis Grave', treatmentKey: 'celulitis_grave_treatment' },
        'celulitis_necrotizante_treatment': { name: 'Tto Celulitis Necrotizante', treatmentKey: 'celulitis_necrotizante_treatment' },
        'gangrena_fournier_treatment': { name: 'Tto Gangrena Fournier', treatmentKey: 'gangrena_fournier_treatment' },
        'fascitis_necrotizante_comunidad_treatment': { name: 'Tto Fascitis Comunidad', treatmentKey: 'fascitis_necrotizante_comunidad_treatment' },
        'fascitis_necrotizante_nosocomial_treatment': { name: 'Tto Fascitis Nosocomial', treatmentKey: 'fascitis_necrotizante_nosocomial_treatment' },
        'foliculitis_leve_treatment': { name: 'Tto Foliculitis Leve', treatmentKey: 'foliculitis_leve_treatment' },
        'foliculitis_extensa_no_sarm_treatment': { name: 'Tto Foliculitis Extensa sin SARM', treatmentKey: 'foliculitis_extensa_no_sarm_treatment' },
        'foliculitis_extensa_con_sarm_treatment': { name: 'Tto Foliculitis Extensa con SARM', treatmentKey: 'foliculitis_extensa_con_sarm_treatment' },
        'forunculos_treatment': { name: 'Tto Forúnculos', treatmentKey: 'forunculos_treatment' },
        'absceso_simple_treatment': { name: 'Tto Absceso Simple', treatmentKey: 'absceso_simple_treatment' },
        'absceso_complicado_treatment': { name: 'Tto Absceso Complicado', treatmentKey: 'absceso_complicado_treatment' },
        'impetigo_treatment': { name: 'Tto Impétigo', treatmentKey: 'impetigo_treatment' },
        'ectima_treatment': { name: 'Tto Ectima', treatmentKey: 'ectima_treatment' },
        'erisipela_treatment': { name: 'Tto Erisipela', treatmentKey: 'erisipela_treatment' },
        'celulitis_no_grave_no_sarm_treatment': { name: 'Tto Celulitis No Grave sin SARM', treatmentKey: 'celulitis_no_grave_no_sarm_treatment' },
        'celulitis_no_grave_con_sarm_treatment': { name: 'Tto Celulitis No Grave con SARM', treatmentKey: 'celulitis_no_grave_con_sarm_treatment' },
        'mordedura_animales_treatment': { name: 'Tto Mordedura', treatmentKey: 'mordedura_animales_treatment' }
    };

    // TRATAMIENTOS (Contenido)
    const treatments = {
        'foliculitis_leve_treatment': {
            characteristics: "Foliculitis leve.",
            recommended: "Ácido fusídico al 1% /12h ó Mupirocina 2%/8h",
            ram: "N/A",
            duration: "5 días",
            measures: "Calor local, clorhexidina 2%. Si fluctúan: drenaje.",
            microorganisms: "S. aureus, P. aeruginosa (piscinas)"
        },
        'foliculitis_extensa_no_sarm_treatment': {
            characteristics: "Foliculitis extensa, sin factores de riesgo para SARM.",
            recommended: "Amoxicilina 500 mg/8h/vo",
            ram: "Cotrimoxazol 160/800 mg/12h/vo (5-10 días)",
            duration: "5 días",
            measures: "N/A",
            microorganisms: "S. aureus, P. aeruginosa"
        },
        'foliculitis_extensa_con_sarm_treatment': {
            characteristics: "Foliculitis extensa, con factores de riesgo para SARM.",
            recommended: "Cotrimoxazol 160/800 mg/12h/vo",
            ram: "N/A",
            duration: "5-10 días",
            measures: "N/A",
            microorganisms: "S. aureus (Riesgo SARM), P. aeruginosa"
        },
        'forunculos_treatment': {
            characteristics: "Forúnculos (abscesificado).",
            recommended: "Amoxicilina 500 mg/8h/vo",
            ram: "Cotrimoxazol 160/800 mg/12h/vo (5-10 días)",
            duration: "5 días",
            measures: "No manipular triángulo central de cara (riesgo trombosis seno cavernoso). Drenaje.",
            microorganisms: "S. aureus"
        },
        'absceso_simple_treatment': {
            characteristics: "Absceso cutáneo simple.",
            recommended: "Ácido fusídico al 1% /12h ó Mupirocina 2%/8h",
            ram: "N/A",
            duration: "5 días",
            measures: "Incisión y drenaje si fluctúa. Cultivos.",
            microorganisms: "S. aureus, Polimicrobiano"
        },
        'absceso_complicado_treatment': {
            characteristics: "Absceso cutáneo complicado.",
            recommended: "Cotrimoxazol 160/800 mg/12h/vo",
            ram: "N/A",
            duration: "5-10 días",
            measures: "Incisión y drenaje quirúrgico. Cultivos.",
            microorganisms: "S. aureus (Riesgo SARM), Polimicrobiano"
        },
        'impetigo_treatment': {
            characteristics: "Impétigo contagioso o ampolloso.",
            recommended: "Leve: Ácido fusídico 1% /12h ó Mupirocina 2%/8h. Diseminada: Amoxicilina 500 mg/8h/vo.",
            ram: "Clindamicina 600mg/8h/vo (7 días)",
            duration: "5 días",
            measures: "MUY CONTAGIOSO. Aislamiento cutáneo. Higiene. Cultivo de pus.",
            microorganisms: "S. pyogenes, +/- S. aureus"
        },
        'ectima_treatment': {
            characteristics: "Ectima (infección ulcerativa).",
            recommended: "Cefadroxilo 1 g/12h/vo",
            ram: "Clindamicina 600mg/8h/vo (7 días)",
            duration: "5 días (si mala evolución: Amoxi-clav 10 días)",
            measures: "Retirar costras, elevar miembro.",
            microorganisms: "S. pyogenes, S. aureus"
        },
        'erisipela_treatment': {
            characteristics: "Erisipela.",
            recommended: "Amoxi-clav 875mg/8h vo",
            ram: "Clindamicina 600 mg/8h/vo",
            duration: "5-7 días",
            measures: "Tomar muestras en inmunodeprimidos.",
            microorganisms: "S. pyogenes, S. aureus"
        },
        'celulitis_no_grave_no_sarm_treatment': {
            characteristics: "Celulitis no grave, sin riesgo SARM.",
            recommended: "Amoxicilina 500 mg/8h. Facial: Amoxi-clav 875mg/8h.",
            ram: "Clindamicina 600 mg/8h/vo",
            duration: "7 días",
            measures: "Elevar miembro, hidratación, tratar puerta de entrada.",
            microorganisms: "S. aureus, S. pyogenes"
        },
        'celulitis_no_grave_con_sarm_treatment': {
            characteristics: "Celulitis no grave, con riesgo SARM.",
            recommended: "Amoxicilina 500 mg/8h (o Amoxi-clav facial) + Cotrimoxazol 160/800 mg/12h.",
            ram: "Clindamicina 600 mg/8h/vo",
            duration: "7 días (Cotrimoxazol 5-10 días)",
            measures: "Elevar miembro, hidratación.",
            microorganisms: "S. aureus (Riesgo SARM), S. pyogenes"
        },
        'mordedura_animales_treatment': {
            characteristics: "Mordedura de animales.",
            recommended: "Amoxi-clav 1 g/12h/vo +/- Ciprofloxacino 500 mg/12h/vo",
            ram: "Ciprofloxacino 500 mg/12h/vo + Clindamicina 300 mg/8h/vo",
            duration: "7-10 días",
            measures: "Valorar drenaje quirúrgico.",
            microorganisms: "Polimicrobiana, Pasteurella, Capnocytophaga"
        },
        // GRAVES
        'celulitis_grave_treatment': {
            characteristics: "Celulitis grave.",
            recommended: "Amoxi-clav 2g/8h iv. Si riesgo SARM: sustituir por Clindamicina.",
            ram: "Clindamicina 600 mg/8h iv",
            duration: "5-7 días",
            measures: "Hemocultivos. Valorar cultivo punción.",
            microorganisms: "S. aureus, Streptococos"
        },
        'celulitis_necrotizante_treatment': {
            characteristics: "Celulitis necrotizante.",
            recommended: "Ceftriaxona 2g/24h iv + Clindamicina 600 mg/6h iv. Si SARM: Clindamicina. Si BLEE: Meropenem.",
            ram: "Clindamicina 600 mg/6h iv + Levofloxacino 750 mg/24h iv",
            duration: "10-14 días",
            measures: "Desbridar tejidos. Hemocultivos.",
            microorganisms: "Streptococos, S. aureus, Anaerobios, Gram-"
        },
        'gangrena_fournier_treatment': {
            characteristics: "Gangrena de Fournier.",
            recommended: "Piperacilina-tazobactam 4g/0.5 g/8h iv. Si SARM: + Linezolid. Si BLEE: Meropenem.",
            ram: "Aztreonam 1g/8h iv + Metronidazol 500 mg/8h iv (+ Linezolid si SARM)",
            duration: "N/A",
            measures: "URGENCIA QUIRÚRGICA. Contactar Cirugía.",
            microorganisms: "Polimicrobiana"
        },
        'fascitis_necrotizante_comunidad_treatment': {
            characteristics: "Fascitis necrotizante (Comunidad).",
            recommended: "Amoxi-clav 2g/8h iv + Clindamicina 600 mg/8h iv. Si sepsis: P/T + Linezolid.",
            ram: "Aztreonam 1g/8h iv + Clindamicina 600 mg/8h iv (+ Linezolid si sepsis)",
            duration: "N/A",
            measures: "URGENCIA QUIRÚRGICA. Desbridamiento amplio.",
            microorganisms: "Streptococos, S. aureus, Anaerobios"
        },
        'fascitis_necrotizante_nosocomial_treatment': {
            characteristics: "Fascitis necrotizante (Nosocomial).",
            recommended: "Meropenem 1 g/8h iv + Clindamicina 600 mg/8h iv + Linezolid 600 mg/12h iv",
            ram: "Tigeciclina 100 mg (carga) + 50 mg/12h + Levofloxacino + Linezolid",
            duration: "N/A",
            measures: "URGENCIA QUIRÚRGICA. Desbridamiento amplio.",
            microorganisms: "Polimicrobiana resistente"
        }
    };

    // INICIO
    document.addEventListener('DOMContentLoaded', () => {
        renderStep();
    });

    function renderStep() {
        const step = workflow[currentStepId];
        
        questionArea.innerHTML = '';
        resultArea.style.display = 'none';
        questionArea.classList.remove('hidden');
        questionArea.style.display = 'block';
        
        renderBreadcrumb();
        backButton.style.display = (currentStepId === 'start') ? 'none' : 'inline-block';

        if (step.treatmentKey) {
            displayTreatment(step.treatmentKey);
            return;
        }

        if (step.type === 'qsofa_calculator') {
            renderQSOFACalculator();
            return;
        }
        if (step.type === 'qsofa_result') {
            displayQSOFAResult(workflow['qsofa_result_display'].html, workflow['qsofa_result_display'].nextFlow);
            return;
        }
        if (step.type && step.type.startsWith('sarm_factors_checker')) {
            renderSARMFactorsChecker(step.type);
            return;
        }

        // Pregunta Estándar
        const title = document.createElement('div');
        title.className = 'question-text';
        title.innerHTML = step.question;
        questionArea.appendChild(title);

        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options-grid';

        step.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerHTML = `<span>${opt.text}</span>`;
            btn.onclick = () => {
                history.push({ id: currentStepId, text: opt.text });
                currentStepId = opt.next;
                renderStep();
            };
            optionsDiv.appendChild(btn);
        });
        questionArea.appendChild(optionsDiv);
    }

    // --- CALCULADORA qSOFA ---
    function renderQSOFACalculator() {
        questionArea.innerHTML = `
            <div class="question-text">Calculadora qSOFA (Quick SOFA)</div>
            <p style="margin-bottom:15px; font-size:0.9rem; color:#666;">Un punto por cada criterio positivo.</p>
            
            <div class="form-group">
                <label>Frecuencia Respiratoria (&ge; 22 rpm)</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="qsofa-fr"> Sí, FR elevada</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Alteración del nivel de conciencia (GCS &lt; 15)</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="qsofa-gcs"> Sí, alteración mental</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Presión Arterial Sistólica (&le; 100 mmHg)</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="qsofa-pas"> Sí, hipotensión</label>
                </div>
            </div>

            <button onclick="calcQSOFA()" class="btn-action btn-primary" style="width:100%; margin-top:10px;">Calcular Riesgo</button>
        `;
    }

    function calcQSOFA() {
        let score = 0;
        if(document.getElementById('qsofa-fr').checked) score++;
        if(document.getElementById('qsofa-gcs').checked) score++;
        if(document.getElementById('qsofa-pas').checked) score++;

        let severityText, next, color;
        if (score >= 2) {
            severityText = 'Alto Riesgo (Grave)';
            next = 'grave_flow_ppb';
            color = '#c62828'; // Rojo
        } else {
            severityText = 'Bajo Riesgo (No Grave)';
            next = 'not_grave_flow_ppb';
            color = '#2e7d32'; // Verde
        }

        workflow['qsofa_result_display'].html = `
            <div style="text-align:center;">
                <div style="font-size:2rem; font-weight:bold; color:${color};">${score} Puntos</div>
                <div style="font-size:1.2rem; margin-bottom:10px;">${severityText}</div>
                <p>El algoritmo sugiere continuar hacia: <strong>${score >= 2 ? 'Infección Grave' : 'Infección No Grave'}</strong></p>
            </div>
        `;
        workflow['qsofa_result_display'].nextFlow = next;
        
        history.push({ id: currentStepId, text: 'Calculadora qSOFA' });
        currentStepId = 'qsofa_result_display';
        renderStep();
    }

    function displayQSOFAResult(html, next) {
        questionArea.innerHTML = html + `
            <button onclick="proceedTo('${next}')" class="btn-action btn-primary" style="width:100%; margin-top:20px;">Continuar</button>
        `;
    }

    function proceedTo(next) {
        currentStepId = next;
        renderStep();
    }

    // --- CHECKER FACTORES SARM ---
    function renderSARMFactorsChecker(type) {
        questionArea.innerHTML = `
            <div class="question-text">Factores de Riesgo para SARM (PPB)</div>
            <div class="checkbox-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <label><input type="checkbox" class="sarm-check"> &gt;1 Coma</label>
                <label><input type="checkbox" class="sarm-check"> TCE</label>
                <label><input type="checkbox" class="sarm-check"> Diabetes Mellitus</label>
                <label><input type="checkbox" class="sarm-check"> SARM previo</label>
                <label><input type="checkbox" class="sarm-check"> ATB &lt; 3 meses</label>
                <label><input type="checkbox" class="sarm-check"> Gripe reciente</label>
                <label><input type="checkbox" class="sarm-check"> Alcoholismo</label>
                <label><input type="checkbox" class="sarm-check"> ERC (Enf. Renal Crónica)</label>
                <label><input type="checkbox" class="sarm-check"> UDVP</label>
                <label><input type="checkbox" class="sarm-check"> Fibrosis quística</label>
            </div>
            <div class="checkbox-group" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <label style="font-weight:bold; color:var(--vithas-blue-light);"><input type="checkbox" id="sarm-none" onchange="toggleChecks(this)"> No tiene factores de riesgo</label>
            </div>
            <button onclick="evaluateSARM('${type}')" class="btn-action btn-primary" style="width:100%; margin-top:15px;">Evaluar</button>
        `;
    }

    function toggleChecks(source) {
        const checkboxes = document.querySelectorAll('.sarm-check');
        checkboxes.forEach(cb => {
            if(source.checked) {
                cb.checked = false;
                cb.disabled = true;
            } else {
                cb.disabled = false;
            }
        });
    }

    function evaluateSARM(type) {
        const none = document.getElementById('sarm-none').checked;
        let hasRisk = false;
        
        if (!none) {
            const checkboxes = document.querySelectorAll('.sarm-check');
            checkboxes.forEach(cb => { if(cb.checked) hasRisk = true; });
        }

        history.push({ id: currentStepId, text: hasRisk ? 'Con Riesgo SARM' : 'Sin Riesgo SARM' });
        
        // Lógica de derivación según el tipo de checker que llamó
        if (type === 'sarm_factors_checker_foliculitis') {
            currentStepId = hasRisk ? 'foliculitis_extensa_con_sarm_treatment' : 'foliculitis_extensa_no_sarm_treatment';
        } else if (type === 'sarm_factors_checker_absceso') {
            currentStepId = 'absceso_complicado_treatment'; // Ambos van al mismo, pero el check es educativo/registro
        } else if (type === 'sarm_factors_checker_celulitis') {
            currentStepId = hasRisk ? 'celulitis_no_grave_con_sarm_treatment' : 'celulitis_no_grave_no_sarm_treatment';
        }
        
        renderStep();
    }

    // --- VISUALIZACIÓN TRATAMIENTO ---
    function displayTreatment(key) {
        questionArea.style.display = 'none';
        resultArea.style.display = 'block';
        
        const data = treatments[key];
        let noteHtml = data.measures ? `<div class="treatment-section"><div class="treatment-label">Otras Medidas</div><p>${data.measures}</p></div>` : '';

        treatmentRecommendation.innerHTML = `
            <div class="treatment-section">
                <div class="treatment-label">Escenario Clínico</div>
                <p>${wrapTooltips(data.characteristics)}</p>
            </div>
            
            <div class="treatment-section" style="border-left: 4px solid var(--vithas-blue-light);">
                <div class="treatment-label" style="color:var(--vithas-blue-light);">Pauta Recomendada</div>
                <div style="font-size:1.1rem; line-height:1.6;">${wrapTooltips(data.recommended)}</div>
                <div style="margin-top:10px; font-size:0.95rem; color:#666;"><strong>Alternativa/RAM:</strong> ${wrapTooltips(data.ram)}</div>
            </div>

            <div class="treatment-section">
                <div class="treatment-label">Duración</div>
                <p>${data.duration}</p>
            </div>
            
            ${noteHtml}
            
            <div class="treatment-section">
                <div class="treatment-label">Microorganismos Probables</div>
                <p style="font-size:0.9rem; color:#555;">${data.microorganisms}</p>
            </div>
        `;
        activateTooltips();
    }

    // --- UTILIDADES ---
    function resetApp() {
        currentStepId = 'start';
        history = [];
        renderStep();
    }

    function goBack() {
        if (history.length > 0) {
            const last = history.pop();
            currentStepId = last.id;
            renderStep();
        }
    }

    function renderBreadcrumb() {
        breadcrumbDiv.innerHTML = '';
        if (history.length === 0 && currentStepId === 'start') return;

        let trail = ['Inicio'];
        history.forEach(item => {
            trail.push(item.text || workflow[item.id].name);
        });
        
        if (workflow[currentStepId]) {
             trail.push(workflow[currentStepId].name);
        } else if (treatments[currentStepId]) {
             trail.push("Tratamiento");
        }

        trail.forEach((t, i) => {
            const span = document.createElement('span');
            span.className = (i === trail.length - 1) ? 'breadcrumb-current' : 'breadcrumb-step';
            span.textContent = t;
            breadcrumbDiv.appendChild(span);
            
            if (i < trail.length - 1) {
                const sep = document.createElement('span');
                sep.className = 'breadcrumb-separator';
                sep.innerHTML = ' / ';
                breadcrumbDiv.appendChild(sep);
            }
        });
    }

    function toggleReference(header) {
        const content = header.nextElementSibling;
        const icon = header.querySelector('i');
        if (content.style.display === 'block') {
            content.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            content.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
    }

    function wrapTooltips(text) {
        if (!text) return '';
        let newText = text;
        Object.keys(antibioticData).forEach(key => {
            // Escape special characters for regex
            const escapedKey = key.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            const regex = new RegExp(`\\b${escapedKey}\\b`, 'gi');
            newText = newText.replace(regex, `<span class="tooltip-trigger" data-key="${key}">${key}</span>`);
        });
        return newText;
    }

    function activateTooltips() {
        const triggers = document.querySelectorAll('.tooltip-trigger');
        const tooltipBox = document.getElementById('global-tooltip');

        triggers.forEach(t => {
            t.addEventListener('mouseenter', (e) => {
                const key = t.getAttribute('data-key');
                // Busca la clave exacta 
                const originalKey = Object.keys(antibioticData).find(k => k.toLowerCase() === key.toLowerCase());
                
                if (originalKey) {
                    const data = antibioticData[originalKey];
                    tooltipBox.innerHTML = `<strong>${originalKey}</strong><br>Dosis: ${data.posologia}<br><span style="font-size:0.8rem; color:#aaa;">${data.precauciones}</span>`;
                    tooltipBox.style.left = e.clientX + 10 + 'px';
                    tooltipBox.style.top = e.clientY + 10 + 'px';
                    tooltipBox.classList.add('active');
                }
            });
            t.addEventListener('mousemove', (e) => {
                tooltipBox.style.left = e.clientX + 10 + 'px';
                tooltipBox.style.top = e.clientY + 10 + 'px';
            });
            t.addEventListener('mouseleave', () => {
                tooltipBox.classList.remove('active');
            });
        });
    }
  </script>
</body>
</html>