<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Protocolo NAC - Vithas Xanit</title>
  
  <link rel="icon" type="image/png" href="../../../assets/Images/Logos/Favicon-Vithas.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <!-- Estilos Globales -->
  <link rel="stylesheet" href="../../../css/style.css" />
  <!-- Estilos Comunes de Focos -->
  <link rel="stylesheet" href="focos-style.css" />

  <style>
    /* Estilos específicos para las tablas de este protocolo */
    .reference-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .reference-table th, .reference-table td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
    }
    .reference-table th {
      background-color: #f5f5f5;
      color: var(--vithas-blue-dark);
      font-weight: 600;
    }
    .fine-calc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .fine-check-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      padding: 8px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .fine-check-label:hover { background: #f9fafb; }
    .input-age {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100px;
    }
    .checkbox-group label {
        display: flex; 
        align-items: flex-start; 
        gap: 10px; 
        margin-bottom: 8px; 
        cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
        margin-top: 3px;
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="../../../assets/images/Logos/Vithas-Logo.jpg" alt="Vithas" class="sidebar-logo">
    </div>
    <nav class="nav-links">
      <ul>
        <li><a href="../../../index.html"><i class="fas fa-home"></i> Inicio</a></li>
        <li class="nav-category">Práctica Clínica</li>
        
        <!-- Volver al menú de Focos -->
        <li><a href="../guia-focos.html"><i class="fas fa-arrow-left"></i> Volver a Guía Focos</a></li>
        
        <!-- BLOQUE ACTUAL: Focos Infecciosos (ABIERTO) -->
        <li class="has-submenu open">
          <a href="#" class="submenu-toggle">
            <div style="display:flex; align-items:center;">
              <i class="fas fa-virus"></i> Focos Infecciosos
            </div>
          </a>
          <ul class="submenu">
            <li><a href="infec-resp-sup.html"><i class="fas fa-head-side-cough"></i> Vías Resp. Superiores</a></li>
            <!-- Elemento Activo -->
            <li><a href="nac.html" class="submenu-main-link active"><i class="fas fa-lungs"></i> Neumonía (NAC)</a></li>
            <li><a href="neumonia-nosocomial.html"><i class="fas fa-hospital-user"></i> Neumonía Nosocomial</a></li>
            <li><a href="itu.html"><i class="fas fa-toilet"></i> Infecciones Urinarias</a></li>
            <li><a href="ets.html"><i class="fas fa-venus-mars"></i> ETS</a></li>
            <li><a href="piel-partes-blandas.html"><i class="fas fa-hand-dots"></i> Piel y Partes Blandas</a></li>
            <li><a href="osteoarticular.html"><i class="fas fa-bone"></i> Osteoarticular</a></li>
            <li><a href="odontogenas.html"><i class="fas fa-tooth"></i> Odontógenas</a></li>
          </ul>
        </li>

        <!-- Accesos directos a otras Utilidades -->
        <li class="nav-category">Otras Herramientas</li>
        
        <li class="has-submenu">
            <a href="../../Analisis_Clinicos/index.html" class="submenu-toggle">
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-microscope"></i> Analíticas
                </div>
            </a>
        </li>

        <li class="has-submenu">
            <a href="../../Gold_EPOC/index.html" class="submenu-toggle">
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-lungs"></i> Guía EPOC
                </div>
            </a>
        </li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <p>Medicina Interna</p>
      <small>Vithas Xanit Internacional</small>
    </div>
  </aside>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="main-content">
    <!-- CABECERO GLOBAL -->
    <header class="top-header">
      <div class="header-left">
        <i class="fas fa-bars menu-toggle" id="menuToggle"></i>
        <h2><i class="fas fa-map-marked-alt" style="margin-right: 10px;"></i>Guía por Localización</h2>
      </div>
      <div class="header-right">
        <img src="../../../assets/images/Logos/Logo-Vithas-Xanit-Internacional.png" alt="Logo" class="top-logo">
      </div>
    </header>

    <div class="content-wrapper foco-container">
      
      <!-- CABECERA INTEGRADA (Título + Instrucción) -->
      <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0;">
          <!-- Parte Izquierda: Icono y Nombre -->
          <div style="display: flex; align-items: center; gap: 15px; flex-grow: 1;">
              <div style="background:#e0f7fa; color:#006064; width:55px; height:55px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.75rem; flex-shrink:0;">
                  <i class="fas fa-lungs"></i>
              </div>
              <div>
                  <h1 style="color: #003A70; font-size: 1.75rem; margin: 0; font-weight: 700; line-height: 1.1;">Neumonía Adquirida en la Comunidad (NAC)</h1>
              </div>
          </div>
          <!-- Parte Derecha: Instrucción -->
          <div style="color: #888; font-weight: 500; font-size: 0.95rem; display: flex; align-items: center;">
              <span style="background: #f5f5f5; padding: 5px 12px; border-radius: 20px; border: 1px solid #e0e0e0;">
                  <i class="fas fa-hand-point-up" style="margin-right: 6px; color: #009FE3;"></i> Seleccione escenario clínico:
              </span>
          </div>
      </div>

      <!-- SECCIÓN INTERACTIVA PRINCIPAL -->
      <section class="foco-card">
        <div class="foco-section-title">Flujo de Decisión Terapéutica</div>
        
        <!-- Breadcrumb -->
        <div id="breadcrumb" class="breadcrumb-trail"></div>

        <!-- Área de Preguntas -->
        <div id="question-area">
          <!-- Se inyecta dinámicamente -->
        </div>

        <!-- Área de Resultados -->
        <div id="result-area" class="result-box" style="display: none;">
          <div class="result-title"><i class="fas fa-check-circle"></i> Recomendación de Tratamiento</div>
          <div id="treatment-recommendation"></div>
          <div style="margin-top: 20px;">
            <button onclick="resetApp()" class="btn-action btn-secondary"><i class="fas fa-redo"></i> Reiniciar</button>
          </div>
        </div>

        <!-- Botón Volver (dentro del flujo) -->
        <div style="margin-top: 20px; text-align: right;">
           <button id="back-button" onclick="goBack()" class="btn-action btn-secondary" style="display: none;">Atrás</button>
        </div>
      </section>

      <!-- SECCIONES DE REFERENCIA -->
      <section class="foco-card">
        <div class="foco-section-title">Información de Referencia</div>

        <!-- 1. Criterios de Ingreso (CURB-65 / PSI) -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Criterios de Ingreso (Escalas CURB-65 / PSI)</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <!-- CORRECCIÓN AQUÍ: Se han escapado los símbolos < y > -->
            <p style="margin-bottom:10px;"><strong>CURB-65:</strong> Confusión, Urea &gt;19 mg/dL (&gt;7 mmol/L), FR &ge;30, PAS &lt;90 o PAD &le;60, Edad &ge;65.</p>
            <table class="reference-table">
                <thead>
                    <tr>
                        <th>Puntuación</th>
                        <th>Mortalidad</th>
                        <th>Recomendación</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>0-1</td><td>Baja (1.5%)</td><td>Tratamiento ambulatorio.</td></tr>
                    <tr><td>2</td><td>Intermedia (9.2%)</td><td>Ingreso hospitalario (o domicilio con supervisión).</td></tr>
                    <tr><td>3-5</td><td>Alta (22%)</td><td>Ingreso hospitalario. Considerar UCI si 4-5.</td></tr>
                </tbody>
            </table>
            <!-- CORRECCIÓN AQUÍ: Se han escapado los símbolos < y > -->
            <p style="margin-top:10px; font-size:0.85rem;">Considerar ingreso si PSI clase IV-V, hipoxemia (SatO2 &lt;90%), derrame pleural, o problemas sociales/psiquiátricos.</p>
          </div>
        </div>

        <!-- 2. Criterios de Gravedad (IDSA/ATS) -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Criterios de Gravedad (UCI)</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <p class="mb-2">Ingreso en UCI si 1 criterio mayor o 3 menores.</p>
            <ul style="list-style-type: disc; padding-left: 20px;">
                <li><strong>Mayores:</strong> Necesidad de ventilación mecánica invasiva, Shock séptico con necesidad de vasopresores.</li>
                <!-- CORRECCIÓN AQUÍ: Se han escapado los símbolos < y > -->
                <li><strong>Menores:</strong> FR &ge;30, PaO2/FiO2 &le;250, Infiltrados multilobares, Confusión/desorientación, Uremia (BUN &ge;20 mg/dL), Leucopenia (&lt;4000), Trombocitopenia (&lt;100.000), Hipotermia (&lt;36ºC), Hipotensión que requiere fluidos agresivos.</li>
            </ul>
          </div>
        </div>

        <!-- 3. Factores de Riesgo para Pseudomonas -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Factores de Riesgo para Pseudomonas aeruginosa</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <ul style="list-style-type: disc; padding-left: 20px;">
                <li>Aislamiento previo de <em>P. aeruginosa</em>.</li>
                <li>Hospitalización reciente (últimos 90 días).</li>
                <li>Uso frecuente de antibióticos (últimos 90 días).</li>
                <li>EPOC grave con bronquiectasias o uso crónico de corticoides orales.</li>
                <li>Inmunosupresión severa.</li>
            </ul>
          </div>
        </div>

        <!-- 4. Escalas de Gravedad (Tabla Restaurada) -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Escala FINE (PSI) Detallada</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <table class="reference-table">
                <thead>
                    <tr>
                        <th colspan="2">Escala FINE (PSI) - Puntuación</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Edad (hombres)</td><td>Nº años</td></tr>
                    <tr><td>Edad (mujeres)</td><td>Nº años - 10</td></tr>
                    <tr><td>Residencia ancianos</td><td>+10</td></tr>
                    <tr><td>Enf. Neoplásica / Hígado / Cerebrovascular / Renal / ICC</td><td>+30 / +20 / +10 / +10 / +10</td></tr>
                    <tr><td>Alt. estado mental</td><td>+20</td></tr>
                    <tr><td>FR &ge; 30 rpm</td><td>+20</td></tr>
                    <!-- CORRECCIÓN AQUÍ -->
                    <tr><td>PAS &lt; 90 mmHg</td><td>+20</td></tr>
                    <!-- CORRECCIÓN AQUÍ -->
                    <tr><td>Tª &lt; 35ºC o &gt; 40ºC</td><td>+15</td></tr>
                    <tr><td>FC &ge; 125 lpm</td><td>+10</td></tr>
                    <!-- CORRECCIÓN AQUÍ -->
                    <tr><td>pH &lt; 7.35</td><td>+30</td></tr>
                    <tr><td>BUN &ge; 30 mg/dL</td><td>+20</td></tr>
                    <!-- CORRECCIÓN AQUÍ -->
                    <tr><td>Na &lt; 130 mmol/L</td><td>+20</td></tr>
                    <tr><td>Glucosa &ge; 250 mg/dL</td><td>+10</td></tr>
                    <!-- CORRECCIÓN AQUÍ -->
                    <tr><td>Hematocrito &lt; 30%</td><td>+10</td></tr>
                    <!-- CORRECCIÓN AQUÍ -->
                    <tr><td>pO2 &lt; 60 mmHg</td><td>+10</td></tr>
                    <tr><td>Derrame pleural</td><td>+10</td></tr>
                </tbody>
            </table>
            <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px;">
                <strong>Interpretación FINE:</strong><br>
                Clase I-II (&lt; 70): Ambulatorio<br>
                Clase III (71-90): Valorar Ingreso<br>
                Clase IV-V (&gt; 90): Ingreso
            </div>
          </div>
        </div>

      </section>

    </div>
    
    <!-- FOOTER -->
    <footer class="footer">
      <p>&copy; 2025 Servicio de Medicina Interna - Hospital Vithas Xanit Internacional.</p>
    </footer>
  </div>

  <!-- TOOLTIP GLOBAL -->
  <div id="global-tooltip"></div>

  <!-- LÓGICA DEL PORTAL -->
  <script src="../../../js/main.js"></script>

  <script>
    const questionArea = document.getElementById('question-area');
    const resultArea = document.getElementById('result-area');
    const treatmentRecommendation = document.getElementById('treatment-recommendation');
    const backButton = document.getElementById('back-button');
    const breadcrumbDiv = document.getElementById('breadcrumb');
    const globalTooltip = document.getElementById('global-tooltip');

    // DATOS DE ANTIBIÓTICOS (Tooltips)
    const antibioticData = {
        "Amoxicilina": { posologia: "1g oral / 8h", precauciones: "Alergia penicilinas. Ajustar en IR." },
        "Amoxi-clav": { posologia: "875/125 mg oral / 8h", precauciones: "Hepatotoxicidad previa." },
        "Cefditoreno": { posologia: "400 mg oral / 12h", precauciones: "Alergia cefalosporinas. Tomar con grasa." },
        "Levofloxacino": { posologia: "500mg/12h o 750mg/24h", precauciones: "Tendinitis, QT largo, evitar en <18 años." },
        "Azitromicina": { posologia: "500 mg oral / 24h", precauciones: "QT largo. Interacciones." },
        "Ceftriaxona": { posologia: "2g IV / 24h", precauciones: "No en neonatos con Ca." },
        "Cefepime": { posologia: "2g IV / 8h", precauciones: "Neurotoxicidad en IR." },
        "Aztreonam": { posologia: "2g IV / 8h", precauciones: "Opción en alergia severa B-lact." }
    };

    // VARIABLES DE ESTADO
    let currentStepId = 'start';
    let history = [];

    // FLUJO DE TRABAJO (Lógica exacta del original)
    const workflow = {
        'start': {
            name: 'Inicio',
            question: '¿El paciente cumple con criterios de gravedad?',
            options: [
                { text: 'Sí (Grave)', next: 'grave_flow' },
                { text: 'No (No Grave)', next: 'not_grave_flow' },
                { text: 'No sé / Calcular FINE', next: 'calculate_fine' }
            ]
        },
        'calculate_fine': {
            name: 'Calcular FINE',
            type: 'fine_calculator'
        },
        'fine_result_display': {
            name: 'Resultado FINE',
            type: 'fine_result'
        },
        'grave_flow': {
            name: 'Neumonía Grave',
            question: '¿El paciente presenta factores de riesgo para Pseudomonas aeruginosa?',
            type: 'p_aeruginosa_factors_checker'
        },
        'not_grave_flow': {
            name: 'Neumonía No Grave',
            question: '¿Requiere el paciente ingreso hospitalario?',
            options: [
                { text: 'Sí (Ingreso Hospitalario)', next: 'not_grave_hospital_treatment' }, // Corrección aquí: apunta directo a tratamiento
                { text: 'No (Manejo Ambulatorio)', next: 'ambulatory_factors_checker' }
            ]
        },
        'ambulatory_factors_checker': {
            name: 'Factores Ambulatorios',
            question: 'Evalúa los siguientes factores para el paciente ambulatorio:',
            type: 'ambulatory_factors_checker_ui'
        },
        // Definición de Tratamientos
        'grave_p_aeruginosa_treatment': { name: 'Tratamiento P. aeruginosa', treatmentKey: 'grave_p_aeruginosa_treatment' },
        'grave_no_p_aeruginosa_treatment': { name: 'Tratamiento No P. aeruginosa', treatmentKey: 'grave_no_p_aeruginosa_treatment' },
        'not_grave_hospital_treatment': { name: 'Tratamiento Hospitalario', treatmentKey: 'not_grave_hospital_treatment' },
        'not_grave_ambulatory_comorbidities_treatment': { name: 'Tratamiento Ambulatorio Comorbilidades', treatmentKey: 'not_grave_ambulatory_comorbidities_treatment' },
        'not_grave_ambulatory_no_comorbidities_treatment': { name: 'Tratamiento Ambulatorio Sin Comorbilidades', treatmentKey: 'not_grave_ambulatory_no_comorbidities_treatment' }
    };

    const treatments = {
        'grave_p_aeruginosa_treatment': {
            characteristics: "Neumonía grave, con factores de riesgo para Pseudomonas aeruginosa.",
            recommended: "Cefepime 2g/8h iv +/- Levofloxacino 500 mg/12 h iv",
            ram: "Aztreonam 2g/8h iv + Levofloxacino 500 mg/12h iv",
            desescalar: "Si 24-48h afebril y buena respuesta clínica.",
            duration: "Si buena respuesta en 48-72h: 7 días",
            microorganisms: "S. pneumoniae, P aeruginosa, H influenzae, Legionella pneumophila, S. aureus, Bacilos G, Virus"
        },
        'grave_no_p_aeruginosa_treatment': {
            characteristics: "Neumonía grave, sin factores de riesgo para Pseudomonas aeruginosa.",
            recommended: "Ceftriaxona 2 g/24h + Azitromicina 500 mg vo/24h",
            ram: "Levofloxacino 750 mg /24h",
            desescalar: "Si 24-48h afebril y buena respuesta clínica.",
            duration: "Si buena respuesta en 48-72h: 7 días",
            microorganisms: "S pneumoniae, H influenzae, Legionella pneumophila, S. aureus, Bacilos G, Virus"
        },
        'not_grave_hospital_treatment': {
            characteristics: "Neumonía no grave, con ingreso hospitalario.",
            recommended: "Ceftriaxona 2 g/24h",
            atypical_add_on: "Azitromicina 500mg vo/24h si sospecha atípicas",
            ram: "Levofloxacino 750 mg /24h",
            desescalar: "Si 24h afebril y buena respuesta clínica.",
            duration: "Si buena respuesta en 48-72h: 5 días",
            microorganisms: "S pneumoniae, Virus, Mycoplasma sp, Chlamydia pneumoniae, C burnetii, H influenzae, Legionella pneumophila"
        },
        'not_grave_ambulatory_comorbidities_treatment': {
            characteristics: "Neumonía no grave, manejo ambulatorio, con >65 años, comorbilidades o ATB en los últimos 3 meses.",
            recommended: "Amoxi-clav 875/125 mg VO /8h ó Cefditoreno 400 mg VO /12h",
            atypical_add_on: "Azitromicina 500mg vo/24h si sospecha atípicas",
            ram: "Levofloxacino 750 mg /24h",
            desescalar: "N/A",
            duration: "5 días (si buena respuesta en 48-72h)",
            microorganisms: "S pneumoniae, Mycoplasma sp, Virus, H influenzae, Chlamydia sp., C burnetii, Legionella pneumophila"
        },
        'not_grave_ambulatory_no_comorbidities_treatment': {
            characteristics: "Neumonía no grave, manejo ambulatorio, sin >65 años, comorbilidades ni ATB en los últimos 3 meses.",
            recommended: "Amoxicilina 1 g VO / 8 horas",
            atypical_add_on: "Valorar monoterapia con Azitromicina 500mg vo/24h si sospecha de atípica",
            ram: "Levofloxacino 750 mg /24h",
            desescalar: "N/A",
            duration: "5 días (si buena respuesta en 48-72h)",
            microorganisms: "S pneumoniae, Mycoplasma sp., Virus, Chlamydia sp, Coxiella burnetii, Haemophilus influenzae, Legionella pneumophila"
        }
    };

    // INICIO
    document.addEventListener('DOMContentLoaded', () => {
        renderStep();
    });

    function renderStep() {
        const step = workflow[currentStepId];
        
        questionArea.innerHTML = '';
        resultArea.style.display = 'none';
        questionArea.classList.remove('hidden');
        questionArea.style.display = 'block';
        
        renderBreadcrumb();
        backButton.style.display = (currentStepId === 'start') ? 'none' : 'inline-block';

        if (step.treatmentKey) {
            displayTreatment(step.treatmentKey);
            return;
        }

        if (step.type === 'fine_calculator') {
            renderFineCalculator();
            return;
        }
        if (step.type === 'fine_result') {
            displayFineResult(workflow['fine_result_display'].html, workflow['fine_result_display'].nextFlow);
            return;
        }
        if (step.type === 'p_aeruginosa_factors_checker') {
            renderPAeruginosaFactorsChecker();
            return;
        }
        if (step.type === 'ambulatory_factors_checker_ui') {
            renderAmbulatoryFactorsChecker();
            return;
        }

        // Renderizado de pregunta estándar
        const title = document.createElement('div');
        title.className = 'question-text';
        title.innerHTML = wrapTooltips(step.question);
        questionArea.appendChild(title);

        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options-grid';

        step.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerHTML = `<span>${opt.text}</span>`;
            btn.onclick = () => {
                history.push({ id: currentStepId, text: opt.text });
                currentStepId = opt.next;
                renderStep();
            };
            optionsDiv.appendChild(btn);
        });
        questionArea.appendChild(optionsDiv);
        
        activateTooltips();
    }

    // --- CALCULADORA FINE ---
    function renderFineCalculator() {
        questionArea.innerHTML = `
            <div class="question-text">Calculadora Índice de Severidad (PSI/FINE)</div>
            <div style="margin-bottom:15px;">
               <label>Edad (años): <input type="number" id="fine-age" class="input-age" value="65"></label>
               <label class="fine-check-label" style="display:inline-flex; margin-left:10px;"><input type="checkbox" id="fine-female"> Mujer (-10)</label>
            </div>
            <div class="fine-calc-grid">
               <label class="fine-check-label"><input type="checkbox" id="fine-residencia"> Residencia (+10)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-neo"> Neoplasia (+30)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-hepato"> Hepatopatía (+20)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-icc"> ICC (+10)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-acv"> ACV (+10)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-renal"> Enf. Renal (+10)</label>
               
               <label class="fine-check-label"><input type="checkbox" id="fine-mental"> Alt. Mental (+20)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-fr"> FR &ge; 30 (+20)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-tas"> TAS &lt; 90 (+20)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-temp"> Tª &lt; 35 o &gt; 40 (+15)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-fc"> FC &ge; 125 (+10)</label>
               
               <label class="fine-check-label"><input type="checkbox" id="fine-ph"> pH &lt; 7.35 (+30)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-bun"> Urea &ge; 30 (+20)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-na"> Na &lt; 130 (+20)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-glu"> Glu &ge; 250 (+10)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-po2"> pO2 &lt; 60 (+10)</label>
               <label class="fine-check-label"><input type="checkbox" id="fine-derrame"> Derrame Pl. (+10)</label>
            </div>
            <button onclick="calcFine()" class="btn-action btn-primary" style="width:100%; margin-top:10px;">Calcular Riesgo</button>
        `;
    }

    function calcFine() {
        let score = parseInt(document.getElementById('fine-age').value) || 0;
        if(document.getElementById('fine-female').checked) score -= 10;
        if(document.getElementById('fine-residencia').checked) score += 10;
        if(document.getElementById('fine-neo').checked) score += 30;
        if(document.getElementById('fine-hepato').checked) score += 20;
        if(document.getElementById('fine-icc').checked) score += 10;
        if(document.getElementById('fine-acv').checked) score += 10;
        if(document.getElementById('fine-renal').checked) score += 10;
        if(document.getElementById('fine-mental').checked) score += 20;
        if(document.getElementById('fine-fr').checked) score += 20;
        if(document.getElementById('fine-tas').checked) score += 20;
        if(document.getElementById('fine-temp').checked) score += 15;
        if(document.getElementById('fine-fc').checked) score += 10;
        if(document.getElementById('fine-ph').checked) score += 30;
        if(document.getElementById('fine-bun').checked) score += 20;
        if(document.getElementById('fine-na').checked) score += 20;
        if(document.getElementById('fine-glu').checked) score += 10;
        if(document.getElementById('fine-po2').checked) score += 10;
        if(document.getElementById('fine-derrame').checked) score += 10;

        let riskClass, next, color;
        if (score <= 70) { 
            riskClass = "Clase I-II (&lt; 70) - Bajo Riesgo"; 
            next = 'not_grave_flow'; 
            color = "green"; 
        } else if (score <= 90) { 
            riskClass = "Clase III (71-90) - Riesgo Moderado"; 
            next = 'not_grave_hospital_treatment'; // Corrección: Directo a tratamiento
            color = "orange"; 
        } else { 
            riskClass = "Clase IV-V (&gt; 90) - Alto Riesgo"; 
            next = 'grave_flow'; 
            color = "red"; 
        }

        workflow['fine_result_display'].html = `
            <div style="text-align:center;">
                <div style="font-size:2rem; font-weight:bold; color:${color === 'red' ? '#c62828' : '#2e7d32'};">${score} Puntos</div>
                <div style="font-size:1.2rem; margin-bottom:10px;">${riskClass}</div>
                <p>El algoritmo sugiere continuar hacia: <strong>${score > 90 ? 'Neumonía Grave' : 'Neumonía No Grave'}</strong></p>
            </div>
        `;
        workflow['fine_result_display'].nextFlow = next;
        
        history.push({ id: currentStepId, text: 'Calculadora FINE' });
        currentStepId = 'fine_result_display';
        renderStep();
    }

    function displayFineResult(html, next) {
        questionArea.innerHTML = html + `
            <button onclick="proceedTo('${next}')" class="btn-action btn-primary" style="width:100%; margin-top:20px;">Continuar</button>
        `;
    }
    
    function proceedTo(next) {
        currentStepId = next;
        renderStep();
    }

    // --- CHECKERS DE FACTORES ---
    function renderPAeruginosaFactorsChecker() {
        questionArea.innerHTML = `
            <h3 class="question-text">Factores de Riesgo para Pseudomonas aeruginosa</h3>
            <div class="checkbox-group" style="margin-bottom:20px;">
                <label><input type="checkbox" class="pa-factor"> Ingreso reciente</label>
                <label><input type="checkbox" class="pa-factor"> &gt;4 ciclos ATB/año</label>
                <label><input type="checkbox" class="pa-factor"> ATB &lt; 3m</label>
                <label><input type="checkbox" class="pa-factor"> EPOC grave</label>
                <label><input type="checkbox" class="pa-factor"> Corticoides orales</label>
                <label><input type="checkbox" class="pa-factor"> Aislamiento previo de P. aeruginosa</label>
                <label style="margin-top:10px; font-weight:bold;"><input type="checkbox" id="pa-no-factors" onchange="toggleFactors(this, 'pa-factor')"> No tiene factores de riesgo</label>
            </div>
            <button onclick="evaluatePAFactors()" class="btn-action btn-primary">Continuar</button>
        `;
    }

    function renderAmbulatoryFactorsChecker() {
        questionArea.innerHTML = `
            <h3 class="question-text">Factores del Paciente Ambulatorio</h3>
            <p style="margin-bottom:10px;">Seleccione si presenta alguno:</p>
            <div class="checkbox-group" style="margin-bottom:20px;">
                <label><input type="checkbox" class="amb-factor"> &gt; 65 años</label>
                <label><input type="checkbox" class="amb-factor"> Comorbilidades</label>
                <label><input type="checkbox" class="amb-factor"> ATB en los últimos 3 meses</label>
                <label style="margin-top:10px; font-weight:bold;"><input type="checkbox" id="amb-no-factors" onchange="toggleFactors(this, 'amb-factor')"> No tiene ninguno de estos factores</label>
            </div>
            <button onclick="evaluateAmbFactors()" class="btn-action btn-primary">Continuar</button>
        `;
    }

    function toggleFactors(masterCheckbox, className) {
        const checkboxes = document.querySelectorAll('.' + className);
        checkboxes.forEach(cb => {
            if (masterCheckbox.checked) {
                cb.checked = false;
                cb.disabled = true;
            } else {
                cb.disabled = false;
            }
        });
    }

    function evaluatePAFactors() {
        const none = document.getElementById('pa-no-factors').checked;
        let hasFactors = false;
        if (!none) {
            const checkboxes = document.querySelectorAll('.pa-factor');
            checkboxes.forEach(cb => { if(cb.checked) hasFactors = true; });
        }
        
        history.push({ id: currentStepId, text: hasFactors ? 'Con FdR Pseudomonas' : 'Sin FdR Pseudomonas' });
        currentStepId = hasFactors ? 'grave_p_aeruginosa_treatment' : 'grave_no_p_aeruginosa_treatment';
        renderStep();
    }

    function evaluateAmbFactors() {
        const none = document.getElementById('amb-no-factors').checked;
        let hasFactors = false;
        if (!none) {
            const checkboxes = document.querySelectorAll('.amb-factor');
            checkboxes.forEach(cb => { if(cb.checked) hasFactors = true; });
        }

        history.push({ id: currentStepId, text: hasFactors ? 'Con FdR Ambulatorios' : 'Sin FdR Ambulatorios' });
        currentStepId = hasFactors ? 'not_grave_ambulatory_comorbidities_treatment' : 'not_grave_ambulatory_no_comorbidities_treatment';
        renderStep();
    }

    // --- VISUALIZACIÓN DE TRATAMIENTO ---
    function displayTreatment(key) {
        questionArea.style.display = 'none';
        resultArea.style.display = 'block';
        
        const data = treatments[key];
        
        let atypicalHtml = data.atypical_add_on ? `<div style="margin-top:5px; font-style:italic;">${wrapTooltips(data.atypical_add_on)}</div>` : '';

        treatmentRecommendation.innerHTML = `
            <div class="treatment-section">
                <div class="treatment-label">Escenario Clínico</div>
                <p>${wrapTooltips(data.characteristics)}</p>
            </div>
            
            <div class="treatment-section" style="border-left: 4px solid var(--vithas-blue-light);">
                <div class="treatment-label" style="color:var(--vithas-blue-light);">Pauta Recomendada</div>
                <div style="font-size:1.1rem; line-height:1.6;">${wrapTooltips(data.recommended)}</div>
                ${atypicalHtml}
                <div style="margin-top:10px; font-size:0.95rem; color:#666;"><strong>Alternativa/RAM:</strong> ${wrapTooltips(data.ram)}</div>
            </div>

            <div class="treatment-section">
                <div class="treatment-label">Duración y Seguimiento</div>
                <p><strong>Duración:</strong> ${data.duration}</p>
                <p><strong>Desescalada:</strong> ${data.desescalar}</p>
            </div>
            
            <div class="treatment-section">
                <div class="treatment-label">Microorganismos Probables</div>
                <p style="font-size:0.9rem; color:#555;">${data.microorganisms}</p>
            </div>
        `;
        activateTooltips();
    }

    // --- UTILIDADES ---
    function resetApp() {
        currentStepId = 'start';
        history = [];
        renderStep();
    }

    function goBack() {
        if (history.length > 0) {
            const last = history.pop();
            currentStepId = last.id;
            renderStep();
        }
    }

    function renderBreadcrumb() {
        breadcrumbDiv.innerHTML = '';
        if (history.length === 0 && currentStepId === 'start') return;

        let trail = ['Inicio'];
        history.forEach(item => {
            trail.push(item.text || workflow[item.id].name);
        });
        // El paso actual
        if (workflow[currentStepId]) {
             trail.push(workflow[currentStepId].name);
        } else if (treatments[currentStepId]) { // Si es un paso de tratamiento directo (keys coinciden)
             trail.push("Tratamiento");
        }

        trail.forEach((t, i) => {
            const span = document.createElement('span');
            span.className = (i === trail.length - 1) ? 'breadcrumb-current' : 'breadcrumb-step';
            span.textContent = t;
            breadcrumbDiv.appendChild(span);
            
            if (i < trail.length - 1) {
                const sep = document.createElement('span');
                sep.className = 'breadcrumb-separator';
                sep.innerHTML = ' / ';
                breadcrumbDiv.appendChild(sep);
            }
        });
    }

    function toggleReference(header) {
        const content = header.nextElementSibling;
        const icon = header.querySelector('i');
        if (content.style.display === 'block') {
            content.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            content.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
    }

    // --- TOOLTIPS ---
    function wrapTooltips(text) {
        if (!text) return '';
        let newText = text;
        Object.keys(antibioticData).forEach(key => {
            const regex = new RegExp(`\\b${key}\\b`, 'gi');
            newText = newText.replace(regex, `<span class="tooltip-trigger" data-key="${key}">${key}</span>`);
        });
        return newText;
    }

    function activateTooltips() {
        const triggers = document.querySelectorAll('.tooltip-trigger');
        const tooltipBox = document.getElementById('global-tooltip');

        triggers.forEach(t => {
            t.addEventListener('mouseenter', (e) => {
                const key = t.getAttribute('data-key');
                // Busca la clave exacta (case-insensitive match manual si es necesario, pero data-key ya debería estar bien)
                // Ajuste para encontrar la key original con mayúsculas/minúsculas correctas
                const originalKey = Object.keys(antibioticData).find(k => k.toLowerCase() === key.toLowerCase());
                
                if (originalKey) {
                    const data = antibioticData[originalKey];
                    tooltipBox.innerHTML = `<strong>${originalKey}</strong><br>Dosis: ${data.posologia}<br><span style="font-size:0.8rem; color:#aaa;">${data.precauciones}</span>`;
                    tooltipBox.style.left = e.clientX + 10 + 'px';
                    tooltipBox.style.top = e.clientY + 10 + 'px';
                    tooltipBox.classList.add('active');
                }
            });
            t.addEventListener('mousemove', (e) => {
                tooltipBox.style.left = e.clientX + 10 + 'px';
                tooltipBox.style.top = e.clientY + 10 + 'px';
            });
            t.addEventListener('mouseleave', () => {
                tooltipBox.classList.remove('active');
            });
        });
    }

  </script>
</body>
</html>