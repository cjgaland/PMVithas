<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Protocolo Infecciones Respiratorias Superiores - Vithas Xanit</title>
  
  <link rel="icon" type="image/png" href="../../../assets/Images/Logos/Favicon-Vithas.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <!-- Estilos Globales -->
  <link rel="stylesheet" href="../../../css/style.css" />
  <!-- Estilos Comunes de Focos -->
  <link rel="stylesheet" href="focos-style.css" />

  <style>
    /* Estilos específicos para este protocolo */
    .reference-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .reference-table th, .reference-table td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
    }
    .reference-table th {
      background-color: #f5f5f5;
      color: var(--vithas-blue-dark);
      font-weight: 600;
    }
    
    .checkbox-group label {
        display: flex; 
        align-items: flex-start; 
        gap: 10px; 
        margin-bottom: 8px; 
        cursor: pointer;
        padding: 8px;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        transition: background 0.2s;
    }
    .checkbox-group label:hover { background: #f9fafb; }
    .checkbox-group input[type="checkbox"] {
        margin-top: 3px;
    }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .input-centor {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100px;
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="../../../assets/images/Logos/Vithas-Logo.jpg" alt="Vithas" class="sidebar-logo">
    </div>
    <nav class="nav-links">
      <ul>
        <li><a href="../../../index.html"><i class="fas fa-home"></i> Inicio</a></li>
        <li class="nav-category">Práctica Clínica</li>
        
        <!-- Volver al menú de Focos -->
        <li><a href="../guia-focos.html"><i class="fas fa-arrow-left"></i> Volver a Guía Focos</a></li>
        
        <!-- BLOQUE ACTUAL: Focos Infecciosos (ABIERTO) -->
        <li class="has-submenu open">
          <a href="#" class="submenu-toggle">
            <div style="display:flex; align-items:center;">
              <i class="fas fa-virus"></i> Focos Infecciosos
            </div>
          </a>
          <ul class="submenu">
            <!-- Elemento Activo -->
            <li><a href="infec-resp-sup.html" class="submenu-main-link active"><i class="fas fa-head-side-cough"></i> Vías Resp. Superiores</a></li>
            <li><a href="nac.html"><i class="fas fa-lungs"></i> Neumonía (NAC)</a></li>
            <li><a href="neumonia-nosocomial.html"><i class="fas fa-hospital-user"></i> Neumonía Nosocomial</a></li>
            <li><a href="itu.html"><i class="fas fa-toilet"></i> Infecciones Urinarias</a></li>
            <li><a href="ets.html"><i class="fas fa-venus-mars"></i> ETS</a></li>
            <li><a href="piel-partes-blandas.html"><i class="fas fa-hand-dots"></i> Piel y Partes Blandas</a></li>
            <li><a href="osteoarticular.html"><i class="fas fa-bone"></i> Osteoarticular</a></li>
            <li><a href="odontogenas.html"><i class="fas fa-tooth"></i> Odontógenas</a></li>
          </ul>
        </li>

        <!-- Accesos directos a otras Utilidades -->
        <li class="nav-category">Otras Herramientas</li>
        
        <li class="has-submenu">
            <a href="../../Analisis_Clinicos/index.html" class="submenu-toggle">
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-microscope"></i> Analíticas
                </div>
            </a>
        </li>

        <li class="has-submenu">
            <a href="../../Gold_EPOC/index.html" class="submenu-toggle">
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-lungs"></i> Guía EPOC
                </div>
            </a>
        </li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <p>Medicina Interna</p>
      <small>Vithas Xanit Internacional</small>
    </div>
  </aside>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="main-content">
    <!-- CABECERO GLOBAL -->
    <header class="top-header">
      <div class="header-left">
        <i class="fas fa-bars menu-toggle" id="menuToggle"></i>
        <h2><i class="fas fa-map-marked-alt" style="margin-right: 10px;"></i>Guía por Localización</h2>
      </div>
      <div class="header-right">
        <img src="../../../assets/images/Logos/Logo-Vithas-Xanit-Internacional.png" alt="Logo" class="top-logo">
      </div>
    </header>

    <div class="content-wrapper foco-container">
      
      <!-- SECCIÓN INTERACTIVA PRINCIPAL -->
      <section class="foco-card">
        
        <!-- CABECERA INTEGRADA (Título + Instrucción) -->
        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0;">
            <!-- Parte Izquierda: Icono y Nombre -->
            <div style="display: flex; align-items: center; gap: 15px; flex-grow: 1;">
                <div style="background:#e0f7fa; color:#006064; width:55px; height:55px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.75rem; flex-shrink:0;">
                    <i class="fas fa-head-side-cough"></i>
                </div>
                <div>
                    <h1 style="color: #003A70; font-size: 1.75rem; margin: 0; font-weight: 700; line-height: 1.1;">Infecciones Respiratorias Superiores</h1>
                </div>
            </div>
            <!-- Parte Derecha: Instrucción -->
            <div style="color: #888; font-weight: 500; font-size: 0.95rem; display: flex; align-items: center;">
                <span style="background: #f5f5f5; padding: 5px 12px; border-radius: 20px; border: 1px solid #e0e0e0;">
                    <i class="fas fa-hand-point-up" style="margin-right: 6px; color: #009FE3;"></i> Seleccione escenario clínico:
                </span>
            </div>
        </div>

        <div class="foco-section-title">Flujo de Decisión Terapéutica</div>
        
        <!-- Breadcrumb -->
        <div id="breadcrumb" class="breadcrumb-trail"></div>

        <!-- Área de Preguntas -->
        <div id="question-area">
          <!-- Se inyecta dinámicamente -->
        </div>

        <!-- Área de Resultados -->
        <div id="result-area" class="result-box" style="display: none;">
          <div class="result-title"><i class="fas fa-check-circle"></i> Recomendación de Tratamiento</div>
          <div id="treatment-recommendation"></div>
          <div style="margin-top: 20px;">
            <button onclick="resetApp()" class="btn-action btn-secondary"><i class="fas fa-redo"></i> Reiniciar</button>
          </div>
        </div>

        <!-- Botón Volver (dentro del flujo) -->
        <div style="margin-top: 20px; text-align: right;">
           <button id="back-button" onclick="goBack()" class="btn-action btn-secondary" style="display: none;">Atrás</button>
        </div>
      </section>

      <!-- SECCIONES DE REFERENCIA -->
      <section class="foco-card">
        <div class="foco-section-title">Información de Referencia</div>

        <!-- 1. Introducción -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Introducción</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <p class="mb-2">Las infecciones respiratorias superiores constituyen procesos muy habituales en la práctica clínica en Atención Primaria. Son la principal causa de consumo de antibióticos, innecesario en muchos casos.</p>
            <p class="mb-2">Se trata de procesos mayoritariamente leves, autolimitados y de origen vírico. Los antibióticos modifican solo ligeramente el curso y pueden causar efectos adversos. La <strong>actitud expectante</strong> y la <strong>prescripción diferida</strong> son estrategias clave.</p>
            <p class="mt-2"><strong>Prescripción inmediata indicada en:</strong></p>
            <ul style="list-style-type: disc; padding-left: 20px;">
                <li>Síntomas/signos de infección severa o complicaciones graves (neumonía, mastoiditis, absceso periamigdalino).</li>
                <li>Alto riesgo de complicaciones (enfermedad cardíaca, pulmonar, renal, hepática, neuromuscular, inmunodepresión, fibrosis quística).</li>
                <li>Mayores de 65 años con criterios de riesgo (hospitalización previa, DM, insuficiencia cardíaca, corticoides).</li>
            </ul>
          </div>
        </div>

        <!-- 2. Criterios de Derivación -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Criterios de Derivación</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <ul style="list-style-type: disc; padding-left: 20px;">
                <li>Fiebre alta (&gt;39ºC) o cefalea intensa con alteraciones visuales, disminución de conciencia o edema periorbitario.</li>
                <li>Ausencia de mejoría tras completar ciclo de tratamiento (Otitis Externa).</li>
                <li>Sospecha de otitis externa maligna (diabéticos, inmunodeprimidos, necrosis).</li>
                <li>Antecedentes de intervención quirúrgica ótica reciente (Otitis Externa).</li>
                <li>Otitis media aguda recurrente (3 episodios en 6 meses; &gt;4 en un año).</li>
                <li>Ausencia de respuesta tras 2 series de antibióticos (OMA).</li>
                <li>Intolerancia a la medicación oral (OMA).</li>
                <li>Afectación importante del estado general (OMA).</li>
                <li>Signos de cuadro séptico intracraneal (meningitis, laberintitis, trombosis del seno lateral) (OMA).</li>
                <li>Dificultad respiratoria o progresión de síntomas a pesar del tratamiento (Laringitis).</li>
                <li>Fiebre elevada con afectación del estado general (Laringitis).</li>
                <li>Laringitis aguda grave (o que no resuelve) o de duración prolongada.</li>
            </ul>
          </div>
        </div>

        <!-- 3. Biodisponibilidad -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Biodisponibilidad Oral de Antibióticos</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <table class="reference-table">
                <thead>
                    <tr>
                        <th>Antibiótico</th>
                        <th>Biodisponibilidad Oral</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Amoxicilina</td><td>80%</td></tr>
                    <tr><td>Amoxicilina-clavulánico</td><td>75% en solución, 60% sólido</td></tr>
                    <tr><td>Cefditoreno</td><td>40-50%</td></tr>
                    <tr><td>Ciprofloxacino</td><td>75%</td></tr>
                    <tr><td>Levofloxacino</td><td>&gt;95%</td></tr>
                    <tr><td>Linezolid</td><td>100%</td></tr>
                </tbody>
            </table>
          </div>
        </div>

      </section>

    </div>
    
    <!-- FOOTER -->
    <footer class="footer">
      <p>&copy; 2025 Servicio de Medicina Interna - Hospital Vithas Xanit Internacional.</p>
    </footer>
  </div>

  <!-- TOOLTIP GLOBAL -->
  <div id="global-tooltip"></div>

  <!-- LÓGICA DEL PORTAL -->
  <script src="../../../js/main.js"></script>

  <script>
    const questionArea = document.getElementById('question-area');
    const resultArea = document.getElementById('result-area');
    const treatmentRecommendation = document.getElementById('treatment-recommendation');
    const backButton = document.getElementById('back-button');
    const breadcrumbDiv = document.getElementById('breadcrumb');
    const globalTooltip = document.getElementById('global-tooltip');

    // DATOS DE ANTIBIÓTICOS (Tooltips)
    const antibioticData = {
        "Amoxicilina": { posologia: "500 mg cada 12h (Faringitis) / 1g cada 8h (OMA/Sinusitis)", precauciones: "Alergia a penicilinas." },
        "Amoxicilina/ácido clavulánico": { posologia: "500/125 mg cada 12h (Faringitis) / 875/125 mg cada 8h (OMA/Sinusitis)", precauciones: "Hepatotoxicidad." },
        "Penicilina V": { posologia: "500 mg oral cada 12 horas", precauciones: "Alergia a penicilinas." },
        "Penicilina G-benzatina": { posologia: "1.200.000 UI IM dosis única", precauciones: "Alergia a penicilinas. NO IV." },
        "Azitromicina": { posologia: "500 mg/24h (3 días) o 500mg día 1 + 250mg días 2-5", precauciones: "QT largo. Interacciones." },
        "Clindamicina": { posologia: "300 mg cada 8 horas", precauciones: "Riesgo colitis C. difficile." },
        "Ciprofloxacino": { posologia: "Tópico ótico: 2-4 gotas cada 8-12h", precauciones: "Seguro en perforación timpánica (tópico)." },
        "Fluocinolona": { posologia: "Tópico combinado", precauciones: "Corticoide local." },
        "Mupirocina": { posologia: "Tópica 2% cada 8h", precauciones: "Uso local exclusivo." },
        "Claritromicina": { posologia: "500 mg cada 12 horas", precauciones: "QT largo. Interacciones (CYP3A4)." },
        "Levofloxacino": { posologia: "500 mg cada 24 horas", precauciones: "Tendinitis, QT largo. Evitar en niños." }
    };

    // VARIABLES DE ESTADO
    let currentStepId = 'start';
    let history = [];

    // FLUJO DE TRABAJO
    const workflow = {
        'start': {
            name: 'Inicio',
            question: 'Seleccione el tipo de infección respiratoria superior:',
            options: [
                { text: 'Faringoamigdalitis', next: 'faringoamigdalitis_start' },
                { text: 'Otitis Media Aguda', next: 'oma_start' },
                { text: 'Otitis Externa', next: 'oe_start' },
                { text: 'Sinusitis Aguda', next: 'sinusitis_start' },
                { text: 'Resfriado Común', next: 'cold_treatment' },
                { text: 'Laringitis Aguda', next: 'laryngitis_treatment' }
            ]
        },
        // --- Faringoamigdalitis ---
        'faringoamigdalitis_start': {
            name: 'Faringoamigdalitis',
            question: '¿Existe sospecha de infección por Estreptococo Beta Hemolítico Grupo A (EBHGA)?',
            options: [
                { text: 'Evaluar con Criterios de Centor-McIsaac', next: 'centor_calculator' },
                { text: 'No (etiología vírica probable)', next: 'faringoamigdalitis_no_ebhga_treatment' },
                { text: 'Es recurrente', next: 'faringoamigdalitis_recurrente_treatment' }
            ]
        },
        'centor_calculator': {
            name: 'Calculadora Centor-McIsaac',
            type: 'centor_calculator_ui'
        },
        'centor_result_display': {
            name: 'Resultado Centor',
            type: 'centor_result'
        },
        // --- Otitis Media Aguda (OMA) ---
        'oma_start': {
            name: 'Otitis Media Aguda',
            question: '¿Presenta signos de gravedad (Fiebre &gt; 39ºC, otalgia intensa)?',
            options: [
                { text: 'Sí (Grave)', next: 'oma_severe_treatment' },
                { text: 'No (Sin gravedad)', next: 'oma_no_severity_treatment' }
            ]
        },
        'oma_fail_initial': {
            name: 'Fallo OMA Inicial',
            question: '¿Persisten síntomas tras 48-72h sin antibiótico (observación)?',
            options: [
                { text: 'Sí, persiste sin mejoría', next: 'oma_fail_initial_treatment' },
                { text: 'Ha mejorado', next: 'oma_resolved' } // No action needed really, but logical end
            ]
        },
        'oma_fail_amoxicilina': {
            name: 'Fallo OMA Amoxicilina',
            question: '¿Persisten síntomas tras 48-72h de tratamiento con Amoxicilina?',
            options: [
                { text: 'Sí, persiste sin mejoría', next: 'oma_fail_amoxicilina_treatment' }
            ]
        },
        // --- Otitis Externa (OE) ---
        'oe_start': {
            name: 'Otitis Externa',
            question: 'Seleccione el tipo de Otitis Externa:',
            options: [
                { text: 'OE Difusa no complicada', next: 'oe_diffuse_no_complication_treatment' },
                { text: 'OE Difusa sin mejoría 48-72h', next: 'oe_diffuse_no_improvement_treatment' },
                { text: 'OE Circunscrita (forúnculo)', next: 'oe_circumscribed_treatment' },
                { text: 'OE Circunscrita con celulitis', next: 'oe_circumscribed_cellulitis_treatment' },
                { text: 'Otomicosis', next: 'oe_otomicosis_treatment' },
                { text: 'Miringitis Bullosa leve', next: 'oe_miringitis_bullosa_mild_treatment' },
                { text: 'Miringitis Bullosa extensa/severa', next: 'oe_miringitis_bullosa_severe_treatment' }
            ]
        },
        // --- Sinusitis Aguda ---
        'sinusitis_start': {
            name: 'Sinusitis Aguda',
            question: '¿Cuál es la presentación clínica?',
            options: [
                { text: 'Leve (< 7-10 días)', next: 'sinusitis_mild_treatment' },
                { text: 'Síntomas intensos > 7-14 días o patrón bacteriano', next: 'sinusitis_intense_symptoms_treatment' },
                { text: 'Fallo a Amoxicilina 48-72h o alta resistencia', next: 'sinusitis_fail_amoxicilina_treatment' },
                { text: 'Signos severos (complicada)', next: 'sinusitis_severe_signs_treatment' },
                { text: 'Paciente con comorbilidades', next: 'sinusitis_comorbidities_treatment' }
            ]
        },
        
        // Tratamientos
        'faringoamigdalitis_no_ebhga_treatment': { name: 'Tratamiento No EBHGA', treatmentKey: 'faringoamigdalitis_no_ebhga_treatment' },
        'faringoamigdalitis_ebhga_treatment': { name: 'Tratamiento EBHGA', treatmentKey: 'faringoamigdalitis_ebhga_treatment' },
        'faringoamigdalitis_recurrente_treatment': { name: 'Tratamiento Recurrente', treatmentKey: 'faringoamigdalitis_recurrente_treatment' },
        'oma_no_severity_treatment': { name: 'Manejo OMA No Grave', treatmentKey: 'oma_no_severity_treatment' },
        'oma_fail_initial_treatment': { name: 'Tratamiento Fallo Inicial', treatmentKey: 'oma_fail_initial_treatment' },
        'oma_fail_amoxicilina_treatment': { name: 'Tratamiento Fallo Amox', treatmentKey: 'oma_fail_amoxicilina_treatment' },
        'oma_severe_treatment': { name: 'Tratamiento OMA Grave', treatmentKey: 'oma_severe_treatment' },
        'oe_diffuse_no_complication_treatment': { name: 'Tratamiento OE Difusa', treatmentKey: 'oe_diffuse_no_complication_treatment' },
        'oe_diffuse_no_improvement_treatment': { name: 'Tratamiento OE Difusa Fallo', treatmentKey: 'oe_diffuse_no_improvement_treatment' },
        'oe_circumscribed_treatment': { name: 'Tratamiento OE Circunscrita', treatmentKey: 'oe_circumscribed_treatment' },
        'oe_circumscribed_cellulitis_treatment': { name: 'Tratamiento OE Celulitis', treatmentKey: 'oe_circumscribed_cellulitis_treatment' },
        'oe_otomicosis_treatment': { name: 'Tratamiento Otomicosis', treatmentKey: 'oe_otomicosis_treatment' },
        'oe_miringitis_bullosa_mild_treatment': { name: 'Tratamiento Miringitis Leve', treatmentKey: 'oe_miringitis_bullosa_mild_treatment' },
        'oe_miringitis_bullosa_severe_treatment': { name: 'Tratamiento Miringitis Severa', treatmentKey: 'oe_miringitis_bullosa_severe_treatment' },
        'cold_treatment': { name: 'Tratamiento Resfriado', treatmentKey: 'cold_treatment' },
        'laryngitis_treatment': { name: 'Tratamiento Laringitis', treatmentKey: 'laryngitis_treatment' },
        'sinusitis_mild_treatment': { name: 'Tratamiento Sinusitis Leve', treatmentKey: 'sinusitis_mild_treatment' },
        'sinusitis_intense_symptoms_treatment': { name: 'Tratamiento Sinusitis Bacteriana', treatmentKey: 'sinusitis_intense_symptoms_treatment' },
        'sinusitis_fail_amoxicilina_treatment': { name: 'Tratamiento Sinusitis Fallo Amox', treatmentKey: 'sinusitis_fail_amoxicilina_treatment' },
        'sinusitis_severe_signs_treatment': { name: 'Tratamiento Sinusitis Severa', treatmentKey: 'sinusitis_severe_signs_treatment' },
        'sinusitis_comorbidities_treatment': { name: 'Tratamiento Sinusitis Comórbida', treatmentKey: 'sinusitis_comorbidities_treatment' }
    };

    // TRATAMIENTOS (Contenido)
    const treatments = {
        'faringoamigdalitis_no_ebhga_treatment': {
            characteristics: "Faringoamigdalitis aguda sin sospecha de EBHGA (etiología vírica).",
            recommended: "No indicado tratamiento antibiótico.",
            ram: "N/A",
            duration: "N/A",
            measures: "Resolver expectativas, hidratación, analgésicos."
        },
        'faringoamigdalitis_ebhga_treatment': {
            characteristics: "Faringoamigdalitis aguda con sospecha de EBHGA.",
            recommended: "Penicilina V 500 mg/12h oral (10 días) ó Amoxicilina 500 mg/12h oral (10 días).",
            atypical_add_on: "Si incumplimiento/intolerancia: Penicilina G-benzatina 1.200.000 UI IM dosis única.",
            ram: "Azitromicina 500 mg/24h (3 días) ó Clindamicina 300 mg/8h (10 días).",
            duration: "10 días (salvo Azitromicina).",
            measures: "Completar tratamiento para evitar recurrencias."
        },
        'faringoamigdalitis_recurrente_treatment': {
            characteristics: "Faringoamigdalitis estreptocócica recurrente (&ge;5 ep/año o cultivo+ tras tto).",
            recommended: "Penicilina G-benzatina 1.200.000 UI IM dosis única ó Amoxicilina/ácido clavulánico 500/125 mg/12h.",
            ram: "Clindamicina 300 mg/8h (10 días).",
            duration: "10 días.",
            measures: "Si persisten recidivas, considerar criterios de amigdalectomía."
        },
        'oma_no_severity_treatment': {
            characteristics: "OMA sin signos de gravedad.",
            recommended: "Actitud expectante / Prescripción diferida. No antibiótico de inicio.",
            ram: "N/A",
            duration: "Reevaluar en 48-72h.",
            measures: "Evitar agua, analgésicos. Si no mejora en 48-72h: Iniciar Amoxicilina."
        },
        'oma_fail_initial_treatment': {
            characteristics: "OMA sin mejoría tras 48-72h de observación.",
            recommended: "Amoxicilina 1g/12h.",
            ram: "Azitromicina 500mg/24h (3 días) ó Claritromicina 500mg/12h (7 días).",
            duration: "7 días (valorar 5 si buena evolución).",
            measures: "Evitar agua."
        },
        'oma_fail_amoxicilina_treatment': {
            characteristics: "OMA sin mejoría tras 48-72h con Amoxicilina.",
            recommended: "Amoxicilina/ácido clavulánico 875/125 mg/8h.",
            ram: "Levofloxacino 500mg/24h (uso off-label en <18, valorar riesgo/beneficio) o consultar ORL.",
            duration: "10 días.",
            measures: "Evitar agua."
        },
        'oma_severe_treatment': {
            characteristics: "OMA Grave (Fiebre &gt; 39ºC, otalgia intensa).",
            recommended: "Amoxicilina/ácido clavulánico 875/125 mg/8h.",
            ram: "Azitromicina 500mg/24h (3 días) ó Claritromicina 500mg/12h.",
            duration: "10 días.",
            measures: "Evitar agua."
        },
        'oe_diffuse_no_complication_treatment': {
            characteristics: "Otitis Externa Difusa no complicada.",
            recommended: "No indicado antibiótico sistémico.",
            ram: "N/A",
            duration: "N/A",
            measures: "Evitar manipulación/agua. Ácido acético 2% o alcohol boricado. Gotas antibióticas si precisa."
        },
        'oe_diffuse_no_improvement_treatment': {
            characteristics: "Otitis Externa Difusa sin mejoría 48-72h.",
            recommended: "Ciprofloxacino tópico 0.3% (2-4 gotas/8-12h).",
            atypical_add_on: "Si edema: Ciprofloxacino + Fluocinolona tópica.",
            ram: "N/A",
            duration: "7-10 días.",
            measures: "Evitar manipulación/agua."
        },
        'oe_circumscribed_treatment': {
            characteristics: "Otitis Externa Circunscrita (forúnculo).",
            recommended: "Mupirocina tópica 2% /8h.",
            ram: "N/A",
            duration: "7 días.",
            measures: "Calor local. Considerar incisión."
        },
        'oe_circumscribed_cellulitis_treatment': {
            characteristics: "Otitis Externa Circunscrita con celulitis.",
            recommended: "Amoxicilina/ácido clavulánico 875/125 mg/8h oral.",
            ram: "Clindamicina 300mg/8h oral.",
            duration: "7-10 días.",
            measures: "Calor local."
        },
        'oe_otomicosis_treatment': {
            characteristics: "Otomicosis.",
            recommended: "Antibióticos contraindicados.",
            ram: "N/A",
            duration: "10-14 días.",
            measures: "Limpieza por aspiración. Alcohol boricado a saturación. Si persiste: Clotrimazol tópico."
        },
        'oe_miringitis_bullosa_mild_treatment': {
            characteristics: "Miringitis Bullosa leve.",
            recommended: "No indicado antibiótico.",
            ram: "N/A",
            duration: "10 días.",
            measures: "Alcohol boricado tópico."
        },
        'oe_miringitis_bullosa_severe_treatment': {
            characteristics: "Miringitis Bullosa extensa/severa (sospecha Mycoplasma).",
            recommended: "Azitromicina 500mg/12h oral.",
            ram: "Claritromicina 500mg/12h.",
            duration: "3 días.",
            measures: "N/A"
        },
        'cold_treatment': {
            characteristics: "Resfriado Común.",
            recommended: "No indicado antibiótico.",
            ram: "N/A",
            duration: "N/A",
            measures: "Sintomático. Lavado de manos. Hidratación."
        },
        'laryngitis_treatment': {
            characteristics: "Laringitis Aguda no complicada.",
            recommended: "No indicado antibiótico.",
            ram: "N/A",
            duration: "N/A",
            measures: "Reposo de voz. Humidificación. Sintomático."
        },
        'sinusitis_mild_treatment': {
            characteristics: "Sinusitis Aguda Leve.",
            recommended: "No indicado antibiótico. Actitud expectante.",
            ram: "N/A",
            duration: "N/A",
            measures: "Lavados nasales, hidratación, analgésicos."
        },
        'sinusitis_intense_symptoms_treatment': {
            characteristics: "Sinusitis: Síntomas intensos > 7-14 días o patrón bacteriano.",
            recommended: "Amoxicilina 1g/8h.",
            ram: "Levofloxacino 500mg/24h ó Claritromicina 500mg/12h.",
            duration: "5-7 días.",
            measures: "Lavados nasales."
        },
        'sinusitis_fail_amoxicilina_treatment': {
            characteristics: "Sinusitis: Fallo a Amoxicilina 48-72h o alta resistencia.",
            recommended: "Amoxicilina/ácido clavulánico 875/125 mg/12h.",
            ram: "Levofloxacino 500mg/24h.",
            duration: "7 días.",
            measures: "Lavados nasales."
        },
        'sinusitis_severe_signs_treatment': {
            characteristics: "Sinusitis con signos severos (complicada).",
            recommended: "Amoxicilina/ácido clavulánico 875/125 mg/12h.",
            ram: "Levofloxacino 500mg/24h ó Claritromicina 500mg/12h.",
            duration: "7 días (mínimo).",
            measures: "Derivación Urgente."
        },
        'sinusitis_comorbidities_treatment': {
            characteristics: "Sinusitis en paciente con comorbilidades.",
            recommended: "Amoxicilina/ácido clavulánico 875/125 mg/12h.",
            ram: "Levofloxacino 500mg/24h.",
            duration: "7 días.",
            measures: "Lavados nasales."
        }
    };

    // INICIO
    document.addEventListener('DOMContentLoaded', () => {
        renderStep();
    });

    function renderStep() {
        const step = workflow[currentStepId];
        
        questionArea.innerHTML = '';
        resultArea.style.display = 'none';
        questionArea.classList.remove('hidden');
        questionArea.style.display = 'block';
        
        renderBreadcrumb();
        backButton.style.display = (currentStepId === 'start') ? 'none' : 'inline-block';

        if (step.treatmentKey) {
            displayTreatment(step.treatmentKey);
            return;
        }

        if (step.type === 'centor_calculator_ui') {
            renderCentorCalculator();
            return;
        }
        if (step.type === 'centor_result') {
            displayCentorResult(workflow['centor_result_display'].html, workflow['centor_result_display'].nextFlow, workflow['centor_result_display'].buttonText);
            return;
        }

        // Pregunta Estándar
        const title = document.createElement('div');
        title.className = 'question-text';
        title.innerHTML = step.question; // No tooltips in questions for cleaner look
        questionArea.appendChild(title);

        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options-grid';

        step.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerHTML = `<span>${opt.text}</span>`;
            btn.onclick = () => {
                history.push({ id: currentStepId, text: opt.text });
                currentStepId = opt.next;
                renderStep();
            };
            optionsDiv.appendChild(btn);
        });
        questionArea.appendChild(optionsDiv);
        
        // Botones adicionales de lógica cruzada (ej. Fallos de tratamiento)
        if (currentStepId === 'oma_no_severity_treatment') {
             // Ya manejado en la vista de tratamiento
        }
    }

    // --- CALCULADORA CENTOR-McISAAC ---
    function renderCentorCalculator() {
        questionArea.innerHTML = `
            <h3 class="question-text">Calculadora de Criterios de Centor-McIsaac</h3>
            <div class="checkbox-group">
                <label><input type="checkbox" id="centor-fever"> Fiebre &gt; 38 ºC</label>
                <label><input type="checkbox" id="centor-exudate"> Exudado amigdalar / Hinchazón</label>
                <label><input type="checkbox" id="centor-nodes"> Adenopatías cervicales anteriores dolorosas</label>
                <label><input type="checkbox" id="centor-no-cough"> Ausencia de tos</label>
            </div>
            <div class="form-group" style="margin-top:15px;">
                <label>Edad (años):</label>
                <input type="number" id="centor-age" class="input-centor" value="30" min="0">
            </div>
            <button onclick="calcCentor()" class="btn-action btn-primary" style="width:100%; margin-top:10px;">Calcular</button>
        `;
    }

    function calcCentor() {
        let score = 0;
        if(document.getElementById('centor-fever').checked) score++;
        if(document.getElementById('centor-exudate').checked) score++;
        if(document.getElementById('centor-nodes').checked) score++;
        if(document.getElementById('centor-no-cough').checked) score++;
        
        const age = parseInt(document.getElementById('centor-age').value);
        if(age >= 3 && age <= 14) score++;
        if(age >= 45) score--;

        let next, buttonText, messageHtml, color;
        
        if (score <= 2) {
            next = 'faringoamigdalitis_no_ebhga_treatment';
            buttonText = 'Ver tratamiento (No EBHGA)';
            color = '#2e7d32'; // Verde
            messageHtml = `<div style="text-align:center;">
                <div style="font-size:2rem; font-weight:bold; color:${color};">${score} Puntos</div>
                <div style="font-size:1.1rem; margin-bottom:10px;">Baja probabilidad de EBHGA</div>
                <p>No se recomienda estudio microbiológico ni antibiótico.</p>
            </div>`;
        } else {
            next = 'faringoamigdalitis_ebhga_treatment';
            buttonText = 'Ver tratamiento (Sospecha EBHGA)';
            color = '#c62828'; // Rojo
            messageHtml = `<div style="text-align:center;">
                <div style="font-size:2rem; font-weight:bold; color:${color};">${score} Puntos</div>
                <div style="font-size:1.1rem; margin-bottom:10px;">Alta probabilidad de EBHGA</div>
                <p>Se recomienda test rápido y/o tratamiento antibiótico.</p>
            </div>`;
        }

        workflow['centor_result_display'].html = messageHtml;
        workflow['centor_result_display'].nextFlow = next;
        workflow['centor_result_display'].buttonText = buttonText;
        
        history.push({ id: currentStepId, text: 'Calculadora Centor' });
        currentStepId = 'centor_result_display';
        renderStep();
    }

    function displayCentorResult(html, next, btnText) {
        questionArea.innerHTML = html + `
            <button onclick="proceedTo('${next}')" class="btn-action btn-primary" style="width:100%; margin-top:20px;">${btnText}</button>
        `;
    }

    function proceedTo(next) {
        currentStepId = next;
        renderStep();
    }

    // --- VISUALIZACIÓN TRATAMIENTO ---
    function displayTreatment(key) {
        questionArea.style.display = 'none';
        resultArea.style.display = 'block';
        
        const data = treatments[key];
        let noteHtml = data.atypical_add_on ? `<div style="margin-top:10px; font-style:italic; font-size:0.9rem; color:#555;">${wrapTooltips(data.atypical_add_on)}</div>` : '';
        let measuresHtml = data.measures ? `<div class="treatment-section"><div class="treatment-label">Otras Medidas</div><p>${data.measures}</p></div>` : '';

        // Botones extra para lógica de fallo terapéutico
        let extraButtons = '';
        if (key === 'faringoamigdalitis_ebhga_treatment') {
            extraButtons = `<button onclick="handleExtraAction('faringoamigdalitis_recurrente_treatment', '¿Es recurrente?')" class="btn-action btn-secondary" style="margin-top:15px; width:100%;">¿Faringoamigdalitis Recurrente?</button>`;
        } else if (key === 'oma_no_severity_treatment') {
            extraButtons = `<button onclick="handleExtraAction('oma_fail_initial_treatment', 'Sin mejoría 48-72h')" class="btn-action btn-secondary" style="margin-top:15px; width:100%; background:#ffebee; color:#c62828; border:1px solid #ef5350;">¿Sin mejoría en 48-72h?</button>`;
        } else if (key === 'oma_fail_initial_treatment') {
             extraButtons = `<button onclick="handleExtraAction('oma_fail_amoxicilina_treatment', 'Sin mejoría con Amoxicilina')" class="btn-action btn-secondary" style="margin-top:15px; width:100%; background:#ffebee; color:#c62828; border:1px solid #ef5350;">¿Sin mejoría con Amox?</button>`;
        } else if (key === 'oe_diffuse_no_complication_treatment') {
             extraButtons = `<button onclick="handleExtraAction('oe_diffuse_no_improvement_treatment', 'Sin mejoría 48-72h')" class="btn-action btn-secondary" style="margin-top:15px; width:100%;">¿Sin mejoría en 48-72h?</button>`;
        } else if (key === 'oe_circumscribed_treatment') {
             extraButtons = `<button onclick="handleExtraAction('oe_circumscribed_cellulitis_treatment', 'Con Celulitis')" class="btn-action btn-secondary" style="margin-top:15px; width:100%;">¿Aparece celulitis?</button>`;
        } else if (key === 'sinusitis_mild_treatment') {
             extraButtons = `<button onclick="handleExtraAction('sinusitis_intense_symptoms_treatment', 'Empeoramiento/Intenso')" class="btn-action btn-secondary" style="margin-top:15px; width:100%;">¿Empeora o síntomas intensos?</button>`;
        } else if (key === 'sinusitis_intense_symptoms_treatment') {
             extraButtons = `<button onclick="handleExtraAction('sinusitis_fail_amoxicilina_treatment', 'Fallo Amoxicilina')" class="btn-action btn-secondary" style="margin-top:15px; width:100%; background:#ffebee; color:#c62828;">¿Fallo Amoxicilina / Resistencia?</button>`;
        }

        treatmentRecommendation.innerHTML = `
            <div class="treatment-section">
                <div class="treatment-label">Escenario Clínico</div>
                <p>${wrapTooltips(data.characteristics)}</p>
            </div>
            
            <div class="treatment-section" style="border-left: 4px solid var(--vithas-blue-light);">
                <div class="treatment-label" style="color:var(--vithas-blue-light);">Pauta Recomendada</div>
                <div style="font-size:1.1rem; line-height:1.6;">${wrapTooltips(data.recommended)}</div>
                ${noteHtml}
                <div style="margin-top:10px; font-size:0.95rem; color:#666;"><strong>Alternativa/RAM:</strong> ${wrapTooltips(data.ram)}</div>
            </div>

            <div class="treatment-section">
                <div class="treatment-label">Duración</div>
                <p>${data.duration}</p>
            </div>
            
            ${measuresHtml}
            ${extraButtons}
        `;
        activateTooltips();
    }

    function handleExtraAction(nextKey, text) {
        history.push({ id: currentStepId, text: text });
        currentStepId = nextKey; // En este caso nextKey es directamente la clave del tratamiento
        // Como es tratamiento directo, necesitamos mapearlo si no está en el workflow como paso
        // Pero mi función renderStep chequea treatmentKey.
        // Un pequeño hack para que renderStep funcione:
        // Si el nextKey está en workflow, bien. Si no, asumimos que es una key de treatment y renderizamos
        // Como en mi workflow he definido steps para cada tratamiento, uso el ID del step del workflow.
        
        // Buscar el ID del step en workflow que tiene este treatmentKey
        let foundStepId = null;
        for (const [key, value] of Object.entries(workflow)) {
            if (value.treatmentKey === nextKey) {
                foundStepId = key;
                break;
            }
        }
        
        if (foundStepId) {
            currentStepId = foundStepId;
            renderStep();
        } else {
            console.error("No se encontró paso para el tratamiento: " + nextKey);
        }
    }

    // --- UTILIDADES ---
    function resetApp() {
        currentStepId = 'start';
        history = [];
        renderStep();
    }

    function goBack() {
        if (history.length > 0) {
            const last = history.pop();
            currentStepId = last.id;
            renderStep();
        }
    }

    function renderBreadcrumb() {
        breadcrumbDiv.innerHTML = '';
        if (history.length === 0 && currentStepId === 'start') return;

        let trail = ['Inicio'];
        history.forEach(item => {
            trail.push(item.text || workflow[item.id].name);
        });
        
        if (workflow[currentStepId]) {
             trail.push(workflow[currentStepId].name);
        }

        trail.forEach((t, i) => {
            const span = document.createElement('span');
            span.className = (i === trail.length - 1) ? 'breadcrumb-current' : 'breadcrumb-step';
            span.textContent = t;
            breadcrumbDiv.appendChild(span);
            
            if (i < trail.length - 1) {
                const sep = document.createElement('span');
                sep.className = 'breadcrumb-separator';
                sep.innerHTML = ' / ';
                breadcrumbDiv.appendChild(sep);
            }
        });
    }

    function toggleReference(header) {
        const content = header.nextElementSibling;
        const icon = header.querySelector('i');
        if (content.style.display === 'block') {
            content.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            content.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
    }

    function wrapTooltips(text) {
        if (!text) return '';
        let newText = text;
        Object.keys(antibioticData).forEach(key => {
            // Escape special characters for regex
            const escapedKey = key.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            const regex = new RegExp(`\\b${escapedKey}\\b`, 'gi');
            newText = newText.replace(regex, `<span class="tooltip-trigger" data-key="${key}">${key}</span>`);
        });
        return newText;
    }

    function activateTooltips() {
        const triggers = document.querySelectorAll('.tooltip-trigger');
        const tooltipBox = document.getElementById('global-tooltip');

        triggers.forEach(t => {
            t.addEventListener('mouseenter', (e) => {
                const key = t.getAttribute('data-key');
                // Busca la clave exacta 
                const originalKey = Object.keys(antibioticData).find(k => k.toLowerCase() === key.toLowerCase());
                
                if (originalKey) {
                    const data = antibioticData[originalKey];
                    tooltipBox.innerHTML = `<strong>${originalKey}</strong><br>Dosis: ${data.posologia}<br><span style="font-size:0.8rem; color:#aaa;">${data.precauciones}</span>`;
                    tooltipBox.style.left = e.clientX + 10 + 'px';
                    tooltipBox.style.top = e.clientY + 10 + 'px';
                    tooltipBox.classList.add('active');
                }
            });
            t.addEventListener('mousemove', (e) => {
                tooltipBox.style.left = e.clientX + 10 + 'px';
                tooltipBox.style.top = e.clientY + 10 + 'px';
            });
            t.addEventListener('mouseleave', () => {
                tooltipBox.classList.remove('active');
            });
        });
    }
  </script>
</body>
</html>