<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Protocolo Infecciones Odontógenas - Vithas Xanit</title>
  
  <link rel="icon" type="image/png" href="../../../assets/Images/Logos/Favicon-Vithas.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <!-- Estilos Globales -->
  <link rel="stylesheet" href="../../../css/style.css" />
  <!-- Estilos Comunes de Focos -->
  <link rel="stylesheet" href="focos-style.css" />

  <style>
    /* Estilos específicos para este protocolo */
    .reference-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .reference-table th, .reference-table td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
    }
    .reference-table th {
      background-color: #f5f5f5;
      color: var(--vithas-blue-dark);
      font-weight: 600;
    }
    
    /* Estilos para cajas de tratamiento específicos de este fichero */
    .treatment-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e0e0e0;
    }
    .treatment-section:last-child {
      border-bottom: none;
    }
    .treatment-label {
      font-weight: 700;
      color: var(--vithas-blue-dark);
      margin-bottom: 0.5rem;
      font-size: 1.05rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .treatment-emphasis {
      font-size: 1.15rem;
      font-weight: 600;
      color: #512da8; /* Morado oscuro para destacar */
      margin: 0.5rem 0;
      padding: 0.75rem;
      background-color: #ede7f6; /* Fondo morado muy suave */
      border-radius: 8px;
      border-left: 4px solid #673ab7;
    }
    .ram-alternative {
      background-color: #fff3e0; /* Naranja muy suave */
      color: #e65100;
      padding: 0.75rem;
      border-radius: 8px;
      font-weight: 600;
      margin-top: 1rem;
      border: 1px solid #ffe0b2;
    }
    .note {
      background-color: #fff8e1; /* Amarillo suave */
      border-left: 4px solid #ffcc80;
      padding: 1rem;
      border-radius: 8px;
      color: #bf360c;
      font-weight: 500;
      margin: 1rem 0;
      font-size: 0.95rem;
    }
    .failure-highlight {
      background-color: #ffebee;
      color: #c62828;
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      font-weight: 700;
      display: block;
      width: 100%;
      margin-top: 1.5rem;
      border: 1px solid #ef9a9a;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }
    .failure-highlight:hover {
      background-color: #ffcdd2;
      transform: translateY(-2px);
    }
    .antibiotic-name {
        font-weight: 600;
        color: var(--vithas-blue-light);
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="../../../assets/images/Logos/Vithas-Logo.jpg" alt="Vithas" class="sidebar-logo">
    </div>
    <nav class="nav-links">
      <ul>
        <li><a href="../../../index.html"><i class="fas fa-home"></i> Inicio</a></li>
        <li class="nav-category">Práctica Clínica</li>
        
        <!-- Volver al menú de Focos -->
        <li><a href="../guia-focos.html"><i class="fas fa-arrow-left"></i> Volver a Guía Focos</a></li>
        
        <!-- BLOQUE ACTUAL: Focos Infecciosos (ABIERTO) -->
        <li class="has-submenu open">
          <a href="#" class="submenu-toggle">
            <div style="display:flex; align-items:center;">
              <i class="fas fa-virus"></i> Focos Infecciosos
            </div>
          </a>
          <ul class="submenu">
            <li><a href="infec-resp-sup.html"><i class="fas fa-head-side-cough"></i> Vías Resp. Superiores</a></li>
            <li><a href="nac.html"><i class="fas fa-lungs"></i> Neumonía (NAC)</a></li>
            <li><a href="neumonia-nosocomial.html"><i class="fas fa-hospital-user"></i> Neumonía Nosocomial</a></li>
            <li><a href="itu.html"><i class="fas fa-toilet"></i> Infecciones Urinarias</a></li>
            <li><a href="ets.html"><i class="fas fa-venus-mars"></i> ETS</a></li>
            <li><a href="piel-partes-blandas.html"><i class="fas fa-hand-dots"></i> Piel y Partes Blandas</a></li>
            <li><a href="osteoarticular.html"><i class="fas fa-bone"></i> Osteoarticular</a></li>
            <!-- Elemento Activo -->
            <li><a href="odontogenas.html" class="submenu-main-link active"><i class="fas fa-tooth"></i> Odontógenas</a></li>
          </ul>
        </li>

        <!-- Accesos directos a otras Utilidades -->
        <li class="nav-category">Otras Herramientas</li>
        
        <li class="has-submenu">
            <a href="../../Analisis_Clinicos/index.html" class="submenu-toggle">
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-microscope"></i> Analíticas
                </div>
            </a>
        </li>

        <li class="has-submenu">
            <a href="../../Gold_EPOC/index.html" class="submenu-toggle">
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-lungs"></i> Guía EPOC
                </div>
            </a>
        </li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <p>Medicina Interna</p>
      <small>Vithas Xanit Internacional</small>
    </div>
  </aside>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="main-content">
    <!-- CABECERO GLOBAL -->
    <header class="top-header">
      <div class="header-left">
        <i class="fas fa-bars menu-toggle" id="menuToggle"></i>
        <h2><i class="fas fa-map-marked-alt" style="margin-right: 10px;"></i>Guía por Localización</h2>
      </div>
      <div class="header-right">
        <img src="../../../assets/images/Logos/Logo-Vithas-Xanit-Internacional.png" alt="Logo" class="top-logo">
      </div>
    </header>

    <div class="content-wrapper foco-container">
      
      <!-- CABECERA INTEGRADA (Título + Instrucción) -->
      <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0;">
          <!-- Parte Izquierda: Icono y Nombre -->
          <div style="display: flex; align-items: center; gap: 15px; flex-grow: 1;">
              <div style="background:#e0f7fa; color:#006064; width:55px; height:55px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.75rem; flex-shrink:0;">
                  <i class="fas fa-tooth"></i>
              </div>
              <div>
                  <h1 style="color: #003A70; font-size: 1.75rem; margin: 0; font-weight: 700; line-height: 1.1;">Infecciones Odontógenas</h1>
              </div>
          </div>
          <!-- Parte Derecha: Instrucción -->
          <div style="color: #888; font-weight: 500; font-size: 0.95rem; display: flex; align-items: center;">
              <span style="background: #f5f5f5; padding: 5px 12px; border-radius: 20px; border: 1px solid #e0e0e0;">
                  <i class="fas fa-hand-point-up" style="margin-right: 6px; color: #009FE3;"></i> Seleccione escenario clínico:
              </span>
          </div>
      </div>

      <!-- SECCIÓN INTERACTIVA PRINCIPAL -->
      <section class="foco-card">
        <div class="foco-section-title">Flujo de Decisión Terapéutica</div>
        
        <!-- Breadcrumb -->
        <div id="breadcrumb" class="breadcrumb-trail"></div>

        <!-- Área de Preguntas -->
        <div id="question-area">
          <!-- Se inyecta dinámicamente -->
        </div>

        <!-- Área de Resultados -->
        <div id="result-area" class="result-box" style="display: none;">
          <div class="result-title"><i class="fas fa-check-circle"></i> Recomendación de Tratamiento</div>
          <div id="treatment-recommendation"></div>
          <div style="margin-top: 20px;">
            <button onclick="resetApp()" class="btn-action btn-secondary"><i class="fas fa-redo"></i> Reiniciar</button>
          </div>
        </div>

        <!-- Botón Volver (dentro del flujo) -->
        <div style="margin-top: 20px; text-align: right;">
           <button id="back-button" onclick="goBack()" class="btn-action btn-secondary" style="display: none;">Atrás</button>
        </div>
      </section>

      <!-- SECCIONES DE REFERENCIA -->
      <section class="foco-card">
        <div class="foco-section-title">Información de Referencia</div>

        <!-- 1. Introducción -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Introducción a Infecciones Odontógenas</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <p class="mb-2">Los procesos infecciosos de la cavidad oral y sus alrededores, cuya causa primaria se localiza en el diente, suelen ser enfermedades autolimitadas, generalmente banales y de muy alta prevalencia (caries, pulpitis, flemón).</p>
            <p class="mb-2">La mayoría de las patologías dentales pueden tratarse con éxito eliminando la infección mediante exodoncia (extracción del diente), tratamiento endodóntico, incisión y drenaje quirúrgico de un absceso, tratamiento periodontal (curetaje gingival) y observación sin necesidad de antibióticos.</p>
            <p class="mb-2">No fumar y una buena higiene bucal son la base de la prevención de la patología dental.</p>
            <p>Otras situaciones son las infecciones odontógenas generalizadas cuando se afectan los planos profundos cérvico-faciales (celulitis) o se produce una repercusión sistémica de la infección localizada. En estos casos, el tratamiento incluye, además de las medidas mecánicas (incisión, desbridamiento y drenaje de colecciones supuradas), la terapia antimicrobiana.</p>
          </div>
        </div>

        <!-- 2. Información sobre Caries -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Información sobre Caries</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <h4>Introducción</h4>
            <p class="mb-2">La caries es una enfermedad de curso crónico causada por los productos químicos de los gérmenes acidógenos. Inicialmente es asintomática. Cuando progresa y alcanza los tejidos dentarios profundos, aparecen síntomas de afectación pulpar.</p>
            <p class="mb-2">La caries puede conducir, en una secuencia temporal, a necrosis pulpar, absceso periapical (flemón) con una posible extensión al hueso subyacente (osteítis u osteomielitis) o en un absceso de planos profundos (celulitis odontógena). Es la causa más frecuente de infección odontógena. De ahí la importancia de su eliminación, para evitar la progresión y el desarrollo de la infección.</p>
            <h4>Etiología</h4>
            <ul style="list-style-type: disc; padding-left: 20px;">
              <li><em>Streptococcus mutans</em></li>
              <li><em>Lactobacillus spp.</em></li>
              <li><em>Actinomyces spp.</em></li>
            </ul>
          </div>
        </div>

        <!-- 3. Información sobre Pulpitis -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Información sobre Pulpitis</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <h4>Introducción</h4>
            <p class="mb-2">La pulpitis es una inflamación de la pulpa dentaria causada por la invasión de los gérmenes locales, bien por progresión de una caries o de una enfermedad periodontal, bien por vía retrógrada desde una infección periapical.</p>
            <p class="mb-2">Aunque se presenta como un cuadro agudo, en realidad traduce en la mayoría de los casos, la exacerbación de una inflamación crónica que anuncia el inicio de un proceso dentario infeccioso, con dolor agudo intenso, continuo, espontáneo e irradiado y que inicialmente aumenta con el frío, posteriormente con el calor y aliviándose con el primero. También aumenta el dolor con la palpación o percusión, con el decúbito y con el esfuerzo.</p>
            <p>Solo se recomienda antibioticoterapia cuando se evidencien síntomas y signos de propagación de la infección o afectación sistémica. Donde haya una ausencia de la infección no hay justificación para el tratamiento terapéutico con antibióticos.</p>
            <h4>Etiología</h4>
            <ul style="list-style-type: disc; padding-left: 20px;">
              <li><em>Peptostreptococcus micros</em></li>
              <li><em>Porphyromonas endodontalis</em></li>
              <li><em>Prevotella intermedia</em></li>
              <li><em>Prevotella melaninogenica</em></li>
              <li><em>Fusobacterium nucleatum</em></li>
            </ul>
          </div>
        </div>

        <!-- 4. Información sobre Absceso Periapical -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Información sobre Absceso Periapical</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <h4>Introducción</h4>
            <p class="mb-2">El absceso periapical agudo localizado (flemón) surge de una pulpa dental inflamada o necrótica o infección del sistema de conductos radiculares sin pulpa.</p>
            <p class="mb-2">Cursa con inflamación y tumefacción intraoral de los tejidos alrededor de la raíz dental y a veces presenta salida de exudado purulento al exterior. Ocasiona una clínica de dolor sordo y bien localizado, referido al diente afecto. Este dolor aumenta con la masticación o con la percusión, a veces con salida de exudado purulento por vía alveolar.</p>
            <p class="mb-2">Los abscesos dentales localizados responden bien a la incisión y drenaje, tratamiento de raíz o la extracción y, por lo tanto, si es posible, es importante la cirugía dental inmediata en lugar de prescribir antibióticos innecesarios.</p>
            <p>Solo se recomienda antibioterapia cuando hay pruebas de propagación de la infección o síntomas o afectación sistémica (linfadenopatía, inflamación difusa, fiebre, malestar general). Donde hay una ausencia de la infección, no hay justificación para el tratamiento terapéutico con antibióticos.</p>
            <h4>Etiología</h4>
            <ul style="list-style-type: disc; padding-left: 20px;">
              <li><em>Peptostreptococcus micros</em></li>
              <li><em>Prevotella oralis melaninogenica</em></li>
              <li><em>Fusobacterium spp.</em></li>
              <li><em>Porphyromonas gingivalis</em></li>
              <li><em>Bacteroides</em></li>
              <li><em>Streptococcus spp.</em></li>
            </ul>
          </div>
        </div>

        <!-- 5. Criterios de Derivación -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Criterios de Derivación</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <ul style="list-style-type: disc; padding-left: 20px;">
              <li>Infecciones graves sin respuesta al tratamiento adecuado (antibioterapia, drenaje y exodoncia o tratamiento conservador).</li>
              <li>Fiebre superior a 39ºC.</li>
              <li>Celulitis odontógenas con tumefacción intra o extraoral.</li>
              <li>Extensión a espacios faciales profundos (parafaríngeos: sublingual, submandibular, submaxilar, laterofaríngeo, retrofaríngeo, pretraqueal) que cursen con trismo intenso, dificultad respiratoria, deglutoria o fonatoria, fiebre alta y malestar, respuesta inadecuada al tratamiento previo o pacientes inmunodeprimidos.</li>
              <li>Paciente no colaborador o incapaz de seguir por sí mismo el tratamiento ambulatorio prescrito.</li>
            </ul>
          </div>
        </div>

        <!-- 6. Biodisponibilidad Oral -->
        <div class="ref-accordion">
          <div class="ref-header" onclick="toggleReference(this)">
            <span>Biodisponibilidad Oral de Antibióticos</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="ref-content">
            <table class="reference-table">
              <thead>
                <tr>
                  <th>Antibiótico</th>
                  <th>Biodisponibilidad Oral</th>
                </tr>
              </thead>
              <tbody>
                <tr><td><span class="antibiotic-name" data-antibiotic="Amoxicilina">Amoxicilina</span></td><td>80%</td></tr>
                <tr><td><span class="antibiotic-name" data-antibiotic="Amoxicilina/ácido clavulánico">Amoxicilina-clavulánico</span></td><td>75% en solución, 60% sólido</td></tr>
                <tr><td><span class="antibiotic-name" data-antibiotic="Cefditoreno">Cefditoreno</span></td><td>40-50%</td></tr>
                <tr><td><span class="antibiotic-name" data-antibiotic="Ciprofloxacino">Ciprofloxacino</span></td><td>75%</td></tr>
                <tr><td><span class="antibiotic-name" data-antibiotic="Levofloxacino">Levofloxacino</span></td><td>&gt;95%</td></tr>
                <tr><td><span class="antibiotic-name" data-antibiotic="Linezolid">Linezolid</span></td><td>100%</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </section>

    </div>
    
    <footer class="footer">
      <p>&copy; 2025 Servicio de Medicina Interna - Hospital Vithas Xanit Internacional.</p>
    </footer>
  </div>

  <!-- TOOLTIP GLOBAL -->
  <div id="global-tooltip"></div>

  <!-- LÓGICA DEL PORTAL -->
  <script src="../../../js/main.js"></script>

  <script>
    const questionArea = document.getElementById('question-area');
    const resultArea = document.getElementById('result-area');
    const treatmentRecommendation = document.getElementById('treatment-recommendation');
    const backButton = document.getElementById('back-button');
    const breadcrumbDiv = document.getElementById('breadcrumb');
    const globalTooltip = document.getElementById('global-tooltip');

    // DATOS DE ANTIBIÓTICOS (Tooltips completos del original)
    const antibioticData = {
        "Amoxicilina": { posologia: "Adultos: 500mg-1g / 8h. Niños: 40-80 mg/kg/día. Profilaxis: 2g.", precauciones: "Alergia penicilinas. Ajustar en IR." },
        "Amoxicilina/ácido clavulánico": { posologia: "Adultos: 500/125mg - 875/125mg / 8h. Niños: 40-80 mg/kg/día.", precauciones: "Hepatotoxicidad. Alergia penicilinas." },
        "Clindamicina": { posologia: "Adultos: 300-600mg / 6-8h. Niños: 10-25 mg/kg/día. Profilaxis: 600mg.", precauciones: "Riesgo colitis C. difficile." },
        "Metronidazol": { posologia: "Adultos: 250-500mg / 8h. Niños: 30 mg/kg/día.", precauciones: "Efecto antabús (No alcohol)." },
        "Espiramicina": { posologia: "Adultos: 1.5 MUI (2 comp) / 12h.", precauciones: "Alternativa en alergia leve." },
        "Azitromicina": { posologia: "Adultos: 500mg / 24h (3 días). Profilaxis: 500mg. Niños: 10mg/kg/día.", precauciones: "QT largo." },
        "Claritromicina": { posologia: "Adultos: 250-500mg / 12h. Niños: 15 mg/kg/día. Profilaxis: 500mg.", precauciones: "Interacciones CYP3A4." },
        "Ampicilina": { posologia: "Parenteral (Profilaxis): 2g IM/IV (Niños: 50mg/kg).", precauciones: "Alergia penicilinas." },
        "Cefazolina": { posologia: "Parenteral (Profilaxis): 1g IM/IV (Niños: 50mg/kg).", precauciones: "Alergia cefalosporinas." },
        "Ceftriaxona": { posologia: "Parenteral: 1g-2g IV/IM.", precauciones: "Alergia cefalosporinas." },
        "Piperacilina/Tazobactam": { posologia: "Parenteral: 4/0.5g IV / 6-8h.", precauciones: "Ajuste renal." },
        "Meropenem": { posologia: "Parenteral: 1g IV / 8h.", precauciones: "Riesgo convulsiones." }
    };

    // VARIABLES DE ESTADO
    let currentStepId = 'start';
    let history = [];

    // FLUJO DE TRABAJO (Original del usuario)
    const workflow = {
      'start': {
        name: 'Inicio',
        question: '¿El paciente presenta signos de propagación de la infección o afectación sistémica?',
        options: [
          { text: 'Sí (Con propagación/sistémica)', next: 'diagnosis_with_spread' },
          { text: 'No (Localizada)', next: 'diagnosis_no_spread' },
          { text: 'No lo sé / Evaluar síntomas', next: 'evaluate_spread_systemic' }
        ]
      },
      'evaluate_spread_systemic': {
        name: 'Evaluar Síntomas',
        question: 'Selecciona los síntomas de propagación o afectación sistémica presentes:',
        type: 'symptom_checker'
      },
      'diagnosis_with_spread': {
        name: 'Diagnóstico (Con Propagación)',
        question: '¿Cuál es el diagnóstico principal de la infección odontógena con propagación o afectación sistémica?',
        options: [
          { text: 'Pulpitis', next: 'pulpitis_with_spread_treatment' },
          { text: 'Absceso Periapical', next: 'abscess_with_spread_treatment' },
          { text: 'Celulitis Odontógena', next: 'odontogenic_cellulitis_treatment' }
        ]
      },
      'diagnosis_no_spread': {
        name: 'Diagnóstico (Localizada)',
        question: '¿Cuál es el diagnóstico principal de la infección odontógena localizada?',
        options: [
          { text: 'Caries', next: 'caries_treatment' },
          { text: 'Pulpitis (reversible o avanzada sin propagación)', next: 'pulpitis_no_spread_type' },
          { text: 'Absceso Periapical Localizado', next: 'abscess_localized_treatment' }
        ]
      },
      'pulpitis_no_spread_type': {
        name: 'Tipo de Pulpitis',
        question: '¿Es pulpitis reversible incipiente o avanzada (irreversible) sin propagación?',
        options: [
          { text: 'Reversible Incipiente', next: 'pulpitis_reversible_treatment' },
          { text: 'Avanzada (Irreversible) sin propagación', next: 'pulpitis_advanced_no_spread_treatment' }
        ]
      },
      // Treatment Endpoints
      'caries_treatment': { name: 'Recomendación de Tratamiento', treatment: 'caries_treatment_content' },
      'pulpitis_reversible_treatment': { name: 'Recomendación de Tratamiento', treatment: 'pulpitis_reversible_treatment_content' },
      'pulpitis_advanced_no_spread_treatment': { name: 'Recomendación de Tratamiento', treatment: 'pulpitis_advanced_no_spread_treatment_content' },
      'pulpitis_with_spread_treatment': { name: 'Recomendación de Tratamiento', treatment: 'pulpitis_with_spread_treatment_content' },
      'pulpitis_failure_treatment': { name: 'Recomendación de Tratamiento', treatment: 'pulpitis_failure_treatment_content' },
      'abscess_localized_treatment': { name: 'Recomendación de Tratamiento', treatment: 'abscess_localized_treatment_content' },
      'abscess_with_spread_treatment': { name: 'Recomendación de Tratamiento', treatment: 'abscess_with_spread_treatment_content' },
      'abscess_failure_treatment': { name: 'Recomendación de Tratamiento', treatment: 'abscess_failure_treatment_content' },
      'odontogenic_cellulitis_treatment': { name: 'Recomendación de Tratamiento', treatment: 'odontogenic_cellulitis_treatment_content' }
    };

    // Define treatment recommendations
    const treatments = {
      'caries_treatment_content': `
        <div class="treatment-section">
          <div class="treatment-label">Características de la Infección:</div>
          <p>Caries (sin signos de propagación o afectación sistémica).</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Tratamiento Antibiótico:</div>
          <div class="treatment-emphasis">No indicado</div>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Medidas No Farmacológicas:</div>
          <ul class="list-disc list-inside">
            <li>Cepillado dental correcto con pasta fluorada (desde 500 ppm hasta 5000 ppm en función de la edad y riesgo de caries) al menos dos veces al día.</li>
            <li>Uso de flúor tópico (pasta, geles o colutorios), especialmente en pacientes con disminución de la secreción salival.</li>
            <li>Reducción de la ingesta de alimentos azucarados.</li>
            <li>Recomendar activamente la revisión por el dentista.</li>
          </ul>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Manejo por Dentista:</div>
          <p>Odontología conservadora: obturación.</p>
        </div>
      `,
      'pulpitis_reversible_treatment_content': `
        <div class="treatment-section">
          <div class="treatment-label">Características de la Infección:</div>
          <p>Pulpitis reversible incipiente (sin signos de propagación o afectación sistémica).</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Tratamiento Antibiótico:</div>
          <div class="treatment-emphasis">No indicado</div>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Manejo:</div>
          <p>Derivar a dentista para no prolongar el dolor y evitar uso innecesario de antibióticos.</p>
          <p><strong>Tratamiento dental:</strong> conservador, endodoncia o exodoncia.</p>
          <div class="note">
            Cuando puede haber demora en el tratamiento conservador o quirúrgico (ej. pacientes discapacitados que necesitan sedación profunda), se indicaría tratamiento antibiótico hasta el tratamiento dental.
          </div>
        </div>
      `,
      'pulpitis_advanced_no_spread_treatment_content': `
        <div class="treatment-section">
          <div class="treatment-label">Características de la Infección:</div>
          <p>Pulpitis avanzada (o irreversible) sin propagación de la infección o afectación sistémica.</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Tratamiento Antibiótico:</div>
          <div class="treatment-emphasis">No indicado</div>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Manejo:</div>
          <p>Tratamiento sintomático (analgésicos, antiinflamatorios).</p>
          <p>Derivar a dentista para no prolongar el dolor y evitar uso innecesario de antibióticos.</p>
          <p><strong>Tratamiento dental:</strong> conservador, endodoncia o exodoncia.</p>
          <div class="note">
            Cuando puede haber demora en el tratamiento conservador o quirúrgico (ej. pacientes discapacitados que necesitan sedación profunda), se indicaría tratamiento antibiótico hasta el tratamiento dental.
          </div>
        </div>
      `,
      'pulpitis_with_spread_treatment_content': `
        <div class="treatment-section">
          <div class="treatment-label">Características de la Infección:</div>
          <p>Pulpitis avanzada (o irreversible) con propagación de la infección o afectación sistémica.</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Tratamiento Recomendado:</div>
          <div class="treatment-emphasis"><strong>Adultos:</strong> <span class="antibiotic-name" data-antibiotic="Amoxicilina">Amoxicilina</span> oral, 500 mg-1 g cada 8 horas, 5-7 días.</div>
          <div class="treatment-emphasis"><strong>Niños:</strong> <span class="antibiotic-name" data-antibiotic="Amoxicilina">Amoxicilina</span> oral, 40 mg/kg/día (dosis máxima: 3 g/día), en 3 tomas, 5-7 días.</div>
          <div class="ram-alternative"><strong>RAM B-lactámicos (Adultos):</strong> <span class="antibiotic-name" data-antibiotic="Metronidazol">Metronidazol</span> oral, 250 mg cada 8 horas, 7 días.</div>
          <div class="ram-alternative"><strong>RAM B-lactámicos (Niños):</strong> <span class="antibiotic-name" data-antibiotic="Metronidazol">Metronidazol</span> oral, 15-30 mg/kg/día cada 8 horas, 7 días.</div>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Manejo y Duración:</div>
          <p>Derivar a dentista.</p>
          <p><strong>Duración:</strong> 5-7 días, revisar a los 2-3 días. Si hay mejoría, se puede interrumpir.</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Microorganismos:</div>
          <p><em>Peptostreptococcus micros, Porphyromonas endodontalis, Prevotella intermedia, Prevotella melaninogenica, Fusobacterium nucleatum.</em></p>
        </div>
        <button onclick="handleAnswer('pulpitis_failure_treatment', 'Fracaso Terapéutico (Pulpitis)')" class="failure-highlight">¿Fracaso Terapéutico?</button>
      `,
      'pulpitis_failure_treatment_content': `
        <div class="treatment-section">
          <div class="treatment-label">Características de la Infección:</div>
          <p>Pulpitis con fracaso terapéutico (no mejoría clínica tras 48 horas con antibióticos de primer escalón).</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Tratamiento Recomendado:</div>
          <div class="treatment-emphasis"><strong>Adultos:</strong> <span class="antibiotic-name" data-antibiotic="Amoxicilina/ácido clavulánico">Amoxicilina/ácido clavulánico</span> oral, 500-875 mg/125 mg, cada 8 horas, 5-7 días.</div>
          <div class="treatment-emphasis"><strong>Niños:</strong> <span class="antibiotic-name" data-antibiotic="Amoxicilina/ácido clavulánico">Amoxicilina/ácido clavulánico</span> oral, 40 mg/Kg/día (dosis máxima: 1 g/día), en 3 tomas, 5-7 días.</div>
          <div class="ram-alternative"><strong>RAM B-lactámicos (Adultos):</strong> <span class="antibiotic-name" data-antibiotic="Claritromicina">Claritromicina</span> oral, 250 mg cada 12 horas, 5 días <strong>ó</strong> <span class="antibiotic-name" data-antibiotic="Clindamicina">Clindamicina</span> oral, 150-300 mg cada 6-8 horas, 5-7 días.</div>
          <div class="ram-alternative"><strong>RAM B-lactámicos (Niños):</strong> <span class="antibiotic-name" data-antibiotic="Claritromicina">Claritromicina</span> oral, 15 mg/Kg (dosis máxima: 1 g/día), en 2 dosis, 5 días <strong>ó</strong> <span class="antibiotic-name" data-antibiotic="Clindamicina">Clindamicina</span> oral, 25 mg/Kg/día en 3-4 tomas, 5-7 días.</div>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Manejo y Duración:</div>
          <p>Derivar a dentista.</p>
          <p><strong>Duración:</strong> 5-7 días, revisar a los 2-3 días. Si hay mejoría, se puede interrumpir.</p>
        </div>
      `,
      'abscess_localized_treatment_content': `
        <div class="treatment-section">
          <div class="treatment-label">Características de la Infección:</div>
          <p>Absceso periapical agudo localizado (flemón).</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Tratamiento Antibiótico:</div>
          <div class="treatment-emphasis">No indicado</div>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Manejo:</div>
          <p>Tratamiento sintomático (analgésicos, antiinflamatorios).</p>
          <p>Derivar a dentista para desbridamiento y drenaje quirúrgico.</p>
          <div class="note">
            Cuando puede haber demora en el tratamiento conservador o quirúrgico, se indicaría tratamiento antibiótico con evaluación periódica cada 2-3 días, hasta el tratamiento mecánico.
          </div>
        </div>
      `,
      'abscess_with_spread_treatment_content': `
        <div class="treatment-section">
          <div class="treatment-label">Características de la Infección:</div>
          <p>Absceso periapical con propagación de la infección, inflamación difusa o síntomas sistémicos.</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Tratamiento Recomendado:</div>
          <div class="treatment-emphasis"><strong>Adultos:</strong> <span class="antibiotic-name" data-antibiotic="Amoxicilina">Amoxicilina</span> oral, 500 mg cada 8 horas, 5 días.</div>
          <div class="treatment-emphasis"><strong>Niños:</strong> <span class="antibiotic-name" data-antibiotic="Amoxicilina">Amoxicilina</span> oral, 40 mg/kg/día (dosis máxima: 3 g/día), en 3 tomas, 5 días.</div>
          <div class="ram-alternative"><strong>RAM B-lactámicos (Adultos):</strong> <span class="antibiotic-name" data-antibiotic="Claritromicina">Claritromicina</span> oral, 250 mg cada 12 horas, 5 días <strong>ó</strong> <span class="antibiotic-name" data-antibiotic="Metronidazol">Metronidazol</span> oral, 250 mg cada 8 horas, 5 días.</div>
          <div class="ram-alternative"><strong>RAM B-lactámicos (Niños):</strong> <span class="antibiotic-name" data-antibiotic="Claritromicina">Claritromicina</span> oral, 15 mg/Kg (dosis máxima: 1 g/día), en 2 dosis, 5 días <strong>ó</strong> <span class="antibiotic-name" data-antibiotic="Metronidazol">Metronidazol</span> oral, 15-30 mg/kg/día cada 8 horas, 5 días.</div>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Manejo y Duración:</div>
          <p>Derivar a dentista para desbridamiento y drenaje quirúrgico.</p>
          <p><strong>Duración:</strong> 5 días, revisar a los 2-3 días. Si hay mejoría, se puede interrumpir.</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Microorganismos:</div>
          <p><em>Peptostreptococcus micros, Prevotella oralis melaninogenica, Fusobacterium spp., Porphyromonas gingivalis, Bacteroides, Streptococcus spp.</em></p>
        </div>
        <button onclick="handleAnswer('abscess_failure_treatment', 'Fracaso Terapéutico (Absceso)')" class="failure-highlight">¿Fracaso Terapéutico?</button>
      `,
      'abscess_failure_treatment_content': `
        <div class="treatment-section">
          <div class="treatment-label">Características de la Infección:</div>
          <p>Absceso periapical con fracaso terapéutico (no mejoría clínica tras 48 horas con antibióticos de primera línea).</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Tratamiento Recomendado:</div>
          <div class="treatment-emphasis"><strong>Adultos:</strong> <span class="antibiotic-name" data-antibiotic="Amoxicilina/ácido clavulánico">Amoxicilina/ácido clavulánico</span> oral, 500-875 mg/125 mg cada 8 horas, 5 días.</div>
          <div class="treatment-emphasis"><strong>Niños:</strong> <span class="antibiotic-name" data-antibiotic="Amoxicilina/ácido clavulánico">Amoxicilina/ácido clavulánico</span> oral, 40 mg/Kg/día (dosis máxima: 1 g/día), en 3 tomas 5 días.</div>
          <div class="ram-alternative"><strong>RAM B-lactámicos (Adultos):</strong> <span class="antibiotic-name" data-antibiotic="Claritromicina">Claritromicina</span> oral, 250 mg cada 12 horas, 5 días <strong>ó</strong> <span class="antibiotic-name" data-antibiotic="Clindamicina">Clindamicina</span> oral, 150 mg, cada 6 horas, 5 días.</div>
          <div class="ram-alternative"><strong>RAM B-lactámicos (Niños):</strong> <span class="antibiotic-name" data-antibiotic="Claritromicina">Claritromicina</span> oral, 15 mg/Kg (dosis máxima: 1 g/día), en 2 dosis, 5 días <strong>ó</strong> <span class="antibiotic-name" data-antibiotic="Clindamicina">Clindamicina</span> oral, 15-25 mg/Kg/día cada 8 horas, 5 días.</div>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Manejo y Duración:</div>
          <p>Derivar a dentista para desbridamiento y drenaje quirúrgico.</p>
          <p><strong>Duración:</strong> 5 días, revisar a los 2-3 días. Si hay mejoría, se puede interrumpir.</p>
        </div>
      `,
      'odontogenic_cellulitis_treatment_content': `
        <div class="treatment-section">
          <div class="treatment-label">Características de la Infección:</div>
          <p>Celulitis odontógena (con tumefacción intra o extraoral, extensión a espacios faciales profundos, etc.).</p>
        </div>
        <div class="urgent-referral-note">
          Derivación URGENTE según criterios de derivación (<a href="#" onclick="toggleReferenceByClass('ref-header')" style="color: #d32f2f; text-decoration: underline;">ver sección de referencia</a>).
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Tratamiento Empírico (hasta derivación):</div>
          <div class="treatment-emphasis"><span class="antibiotic-name" data-antibiotic="Amoxicilina/ácido clavulánico">Amoxicilina/ácido clavulánico</span> 875mg/125mg cada 8 horas VO</div>
          <div class="ram-alternative"><strong>RAM B-lactámicos:</strong> <span class="antibiotic-name" data-antibiotic="Clindamicina">Clindamicina</span> 300mg cada 6 horas VO</div>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Manejo:</div>
          <p>Tratamiento dental: desbridamiento y drenaje quirúrgico, eliminación de la fuente de infección.</p>
          <p>Monitorización estrecha de signos vitales y progresión de la infección.</p>
        </div>
        <div class="treatment-section">
          <div class="treatment-label">Microorganismos:</div>
          <p><em>Polimicrobiana (aerobios y anaerobios orales)</em></p>
        </div>
      `
    };

    // State variables (FIXED: Removing duplicate declaration if it existed)
    // let currentStepId = 'start'; // Already declared above
    // let history = []; // Already declared above

    // Initial render when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      renderQuestion();
      initializeTooltips();
    });

    // Function to wrap text with tooltip spans
    function wrapWithTooltip(text) {
      if (!text) return '';
      let wrappedText = text;
      
      // Wrap antibiotic names
      for (const antibioticName in antibioticData) {
        const regex = new RegExp(`\\b${antibioticName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\b`, 'g');
        wrappedText = wrappedText.replace(regex, `<span class="antibiotic-name" data-antibiotic="${antibioticName}">${antibioticName}</span>`);
      }
      
      // Wrap "criterios de derivación"
      wrappedText = wrappedText.replace(/criterios de derivación/gi, '<span class="tooltip-trigger" data-tooltip-type="derivation-criteria">criterios de derivación</span>');
      
      return wrappedText;
    }

    // Function to render the current question or calculator
    function renderQuestion() {
      const step = workflow[currentStepId];

      if (!step) {
        console.error("Error: currentStepId no corresponde a un paso definido.");
        resetApp();
        return;
      }

      questionArea.innerHTML = '';
      resultArea.style.display = 'none';
      questionArea.style.display = 'block';
      
      backButton.style.display = currentStepId === 'start' ? 'none' : 'inline-block';
      renderBreadcrumb();

      if (step.treatment) {
        displayTreatment(step.treatment);
        questionArea.style.display = 'none';
        return;
      }

      if (step.type === 'symptom_checker') {
        renderSymptomChecker();
      } else {
        let questionText = wrapWithTooltip(step.question);

        let optionsHtml = step.options.map(option => {
          const displayOptionText = wrapWithTooltip(option.text);
          return `
            <button onclick="handleAnswer('${option.next}', '${option.text}')" class="btn-option">
              <i class="fas fa-arrow-right"></i> ${displayOptionText}
            </button>
          `;
        }).join('');

        questionArea.innerHTML = `
          <div class="question-text">${questionText}</div>
          <div class="options-grid">
            ${optionsHtml}
          </div>
        `;
      }

      initializeTooltips();
    }

    // Function to render the symptom checker UI
    function renderSymptomChecker() {
      questionArea.innerHTML = `
        <div class="question-text">Selecciona los signos de propagación o afectación sistémica presentes:</div>
        <div class="checkbox-group">
          <label><input type="checkbox" id="symptom-lymphadenopathy"> Linfadenopatía</label>
          <label><input type="checkbox" id="symptom-diffuse-inflammation"> Inflamación difusa</label>
          <label><input type="checkbox" id="symptom-fever"> Fiebre (>37.7ºC)</label>
          <label><input type="checkbox" id="symptom-malaise"> Malestar general</label>
          <label><input type="checkbox" id="symptom-celulitis-extraoral"> Celulitis odontógena con tumefacción extraoral</label>
          <label><input type="checkbox" id="symptom-deep-space-extension"> Extensión a espacios faciales profundos (trismo intenso, dificultad respiratoria/deglutoria/fonatoria)</label>
          <label><input type="checkbox" id="symptom-no-spread" onchange="toggleSymptoms(this)"> <strong>Ninguno de los anteriores</strong></label>
        </div>
        <button onclick="evaluateSymptoms()" class="btn-action btn-primary"><i class="fas fa-play"></i> Continuar</button>
      `;
    }

    // Function to toggle symptom checkboxes
    function toggleSymptoms(checkbox) {
      const symptoms = document.querySelectorAll('#question-area input[type="checkbox"]:not(#symptom-no-spread)');
      symptoms.forEach(symptom => {
        symptom.checked = false;
        symptom.disabled = checkbox.checked;
      });
    }

    // Function to evaluate symptoms and proceed
    function evaluateSymptoms() {
      const noSpreadChecked = document.getElementById('symptom-no-spread').checked;
      let hasSymptoms = false;

      if (!noSpreadChecked) {
        const symptoms = document.querySelectorAll('#question-area input[type="checkbox"]:not(#symptom-no-spread)');
        for (const symptom of symptoms) {
          if (symptom.checked) {
            hasSymptoms = true;
            break;
          }
        }
      }

      history.push({ id: currentStepId, text: 'Evaluación de Síntomas' });
      if (hasSymptoms) {
        currentStepId = 'diagnosis_with_spread';
      } else {
        currentStepId = 'diagnosis_no_spread';
      }
      renderQuestion();
    }

    // Function to render the breadcrumb
    function renderBreadcrumb() {
      breadcrumbDiv.innerHTML = '';
      if (history.length === 0 && currentStepId === 'start') return;

      let trail = ['Inicio'];
      history.forEach(item => {
        trail.push(item.text);
      });
      
      if (workflow[currentStepId]) {
        trail.push(workflow[currentStepId].name);
      } else if (treatments[currentStepId]) {
        trail.push("Tratamiento");
      }

      trail.forEach((t, i) => {
        const span = document.createElement('span');
        span.className = (i === trail.length - 1) ? 'breadcrumb-current' : 'breadcrumb-step';
        span.textContent = t;
        if (i !== trail.length - 1) {
          span.onclick = () => goToStepInHistory(i - 1);
        }
        breadcrumbDiv.appendChild(span);
        
        if (i < trail.length - 1) {
          const sep = document.createElement('span');
          sep.className = 'breadcrumb-separator';
          sep.innerHTML = ' / ';
          breadcrumbDiv.appendChild(sep);
        }
      });
    }

    // Function to go to a specific step in history
    function goToStepInHistory(index) {
      history = history.slice(0, index + 1);
      currentStepId = history.length > 0 ? history[history.length - 1].id : 'start';
      renderQuestion();
    }

    // Function to handle user's answer
    function handleAnswer(nextStepId, currentOptionText) {
      if (currentStepId !== 'evaluate_spread_systemic') {
        history.push({ id: currentStepId, text: currentOptionText });
      }
      currentStepId = nextStepId;
      const nextStep = workflow[currentStepId];

      if (nextStep && nextStep.treatment) {
        displayTreatment(nextStep.treatment);
      } else {
        renderQuestion();
      }
    }

    // Function to go back to the previous step
    function goBack() {
      if (history.length > 0) {
        const prevStep = history.pop();
        currentStepId = prevStep.id;
        renderQuestion();
      }
    }

    // Function to display the final treatment recommendation
    function displayTreatment(treatmentKey) {
      questionArea.style.display = 'none';
      resultArea.style.display = 'block';
      
      let treatmentHtml = treatments[treatmentKey];
      treatmentHtml = wrapWithTooltip(treatmentHtml);

      treatmentRecommendation.innerHTML = treatmentHtml;
      backButton.style.display = 'inline-block';
      initializeTooltips();
    }

    // Function to reset the application
    function resetApp() {
      currentStepId = 'start';
      history = [];
      renderQuestion();
    }

    // Tooltip functionality
    function initializeTooltips() {
      const antibioticElements = document.querySelectorAll('.antibiotic-name');
      const tooltipTriggers = document.querySelectorAll('.tooltip-trigger');
      
      antibioticElements.forEach(el => {
        el.addEventListener('mouseenter', showAntibioticTooltip);
        el.addEventListener('mouseleave', hideTooltip);
      });
      
      tooltipTriggers.forEach(el => {
        el.addEventListener('mouseenter', showDerivationTooltip);
        el.addEventListener('mouseleave', hideTooltip);
      });
    }

    function showAntibioticTooltip(e) {
      const antibioticName = e.target.dataset.antibiotic;
      if (!antibioticName || !antibioticData[antibioticName]) return;
      
      const data = antibioticData[antibioticName];
      globalTooltip.innerHTML = `
        <strong>${antibioticName}</strong><br>
        <strong>Posología:</strong> ${data.posologia}<br>
        <strong>Eventos Adversos:</strong> ${data.eventosAdversos}<br>
        <strong>Precauciones:</strong> ${data.precauciones}<br>
        <strong>Interacciones:</strong> ${data.interacciones}
      `;
      
      positionTooltip(e);
      globalTooltip.classList.add('active');
    }

    function showDerivationTooltip(e) {
      const content = derivationCriteriaData.map(item => `<li>${item}</li>`).join('');
      globalTooltip.innerHTML = `<strong>Criterios de Derivación:</strong><ul>${content}</ul>`;
      positionTooltip(e);
      globalTooltip.classList.add('active');
    }

    function positionTooltip(e) {
      const x = e.clientX + 15;
      const y = e.clientY + 15;
      const tooltipRect = globalTooltip.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;

      let left = x;
      let top = y;

      if (x + tooltipRect.width > viewportWidth - 10) {
        left = x - tooltipRect.width - 30;
      }
      
      if (y + tooltipRect.height > viewportHeight - 10) {
        top = y - tooltipRect.height - 30;
      }

      globalTooltip.style.left = `${left}px`;
      globalTooltip.style.top = `${top}px`;
    }

    function hideTooltip() {
      globalTooltip.classList.remove('active');
    }

    // Function to toggle reference sections
    function toggleReference(header) {
      const content = header.nextElementSibling;
      const icon = header.querySelector('i.fa-chevron-down, i.fa-chevron-up');
      
      if (content.style.display === 'block') {
        content.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
      } else {
        content.style.display = 'block';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
      }
    }

    function toggleReferenceByClass(className) {
      const headers = document.querySelectorAll(`.${className}`);
      headers.forEach(header => {
        if (header.textContent.includes('Criterios de Derivación')) {
          const content = header.nextElementSibling;
          const icon = header.querySelector('i.fa-chevron-down, i.fa-chevron-up');
          
          if (content.style.display !== 'block') {
            content.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
          }
          
          content.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    // Hide tooltip on scroll
    window.addEventListener('scroll', hideTooltip);
  </script>
</body>
</html>